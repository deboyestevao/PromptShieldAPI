<!doctype html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/adminDashboard.css" rel="stylesheet" type="text/css">
    <link href="/css/adminConfigHistory.css" rel="stylesheet" type="text/css">
    <title>Hist√≥rico de Configura√ß√µes - PromptShield</title>
</head>
<body>
<header class="admin-header">
    <div class="admin-logo">
        <a href="/chat">PromptShield</a>
        <span class="admin-badge">Admin</span>
    </div>
    <div class="admin-user-info">
        <span class="admin-avatar">A</span>
    </div>
</header>
<main class="admin-main">
    <a href="/admin/dashboard" class="admin-back">‚Üê Voltar ao Dashboard</a>
    <h1>Hist√≥rico de Configura√ß√µes do Sistema</h1>
    
    <!-- Filtros e Pesquisa -->
    <section class="admin-filters-section">
        <div class="filters-container">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Pesquisar por utilizador..." class="search-input">
                <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8" stroke-width="2"/>
                    <path d="m21 21-4.35-4.35" stroke-width="2"/>
                </svg>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="openai">OpenAI</button>
                <button class="filter-btn" data-filter="ollama">Ollama</button>
                <button class="filter-btn" data-filter="enabled">Ativados</button>
                <button class="filter-btn" data-filter="disabled">Desativados</button>
            </div>
            
            <div class="date-filter">
                <label for="date-from">De:</label>
                <input type="date" id="date-from" class="date-input">
                <label for="date-to">At√©:</label>
                <input type="date" id="date-to" class="date-input">
                <button id="clear-filters" class="clear-filters-btn">Limpar Filtros</button>
            </div>
        </div>
    </section>

    <!-- Estat√≠sticas -->
    <section class="admin-stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-entries">0</div>
                <div class="stat-label">Total de Entradas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="openai-entries">0</div>
                <div class="stat-label">Altera√ß√µes OpenAI</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="ollama-entries">0</div>
                <div class="stat-label">Altera√ß√µes Ollama</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unique-users">0</div>
                <div class="stat-label">Utilizadores √önicos</div>
            </div>
        </div>
    </section>

    <!-- Lista de Hist√≥rico -->
    <section class="admin-history-section">
        <div class="history-header">
            <h2>Registos de Altera√ß√µes</h2>
            <div class="history-controls">
                <button id="refresh-history" class="refresh-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M1 4v6h6" stroke-width="2"/>
                        <path d="M23 20v-6h-6" stroke-width="2"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4-4.64 4.36A9 9 0 0 1 3.51 15" stroke-width="2"/>
                    </svg>
                    Atualizar
                </button>
            </div>
        </div>

        <div id="history-loading" class="history-loading">
            <div class="loading-spinner"></div>
            <span>A carregar hist√≥rico...</span>
        </div>

        <div id="history-content" class="history-content" style="display:none;">
            <div id="history-list" class="history-list"></div>
        </div>

        <div id="history-empty" class="history-empty" style="display:none;">
            <div class="empty-icon">üìã</div>
            <h3>Nenhum registo encontrado</h3>
            <p>N√£o foram encontrados registos de altera√ß√µes com os filtros aplicados.</p>
        </div>

        <div id="history-error" class="history-error" style="display:none;">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3>Erro ao carregar hist√≥rico</h3>
            <p>Ocorreu um erro ao carregar o hist√≥rico de configura√ß√µes.</p>
            <button onclick="loadHistory()" class="retry-btn">Tentar Novamente</button>
        </div>
    </section>
</main>

<script>
let allHistoryData = [];
let filteredHistoryData = [];

// Carrega o hist√≥rico
async function loadHistory() {
    const loadingDiv = document.getElementById('history-loading');
    const contentDiv = document.getElementById('history-content');
    const emptyDiv = document.getElementById('history-empty');
    const errorDiv = document.getElementById('history-error');
    
    loadingDiv.style.display = 'flex';
    contentDiv.style.display = 'none';
    emptyDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    
    try {
        const resp = await fetch('/admin/api/config-history');
        if (resp.ok) {
            allHistoryData = await resp.json();
            filteredHistoryData = [...allHistoryData];
            updateStats();
            applyFilters();
            // Esconder o loading ap√≥s carregar com sucesso
            loadingDiv.style.display = 'none';
        } else {
            throw new Error('Erro ao carregar hist√≥rico');
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
    }
}

// Atualiza estat√≠sticas
function updateStats() {
    const total = allHistoryData.length;
    const openai = allHistoryData.filter(entry => entry.model === 'OPENAI').length;
    const ollama = allHistoryData.filter(entry => entry.model === 'OLLAMA').length;
    const uniqueUsers = new Set(allHistoryData.map(entry => entry.changedBy)).size;
    
    document.getElementById('total-entries').textContent = total;
    document.getElementById('openai-entries').textContent = openai;
    document.getElementById('ollama-entries').textContent = ollama;
    document.getElementById('unique-users').textContent = uniqueUsers;
}

// Aplica filtros
function applyFilters() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    
    filteredHistoryData = allHistoryData.filter(entry => {
        // Filtro de pesquisa
        if (searchTerm && !entry.changedBy.toLowerCase().includes(searchTerm)) {
            return false;
        }
        
        // Filtro de modelo
        if (activeFilter !== 'all') {
            if (activeFilter === 'openai' && entry.model !== 'OPENAI') return false;
            if (activeFilter === 'ollama' && entry.model !== 'OLLAMA') return false;
            if (activeFilter === 'enabled' && !entry.enabled) return false;
            if (activeFilter === 'disabled' && entry.enabled) return false;
        }
        
        // Filtro de data
        if (dateFrom || dateTo) {
            const entryDate = new Date(entry.changedAt).toISOString().split('T')[0];
            if (dateFrom && entryDate < dateFrom) return false;
            if (dateTo && entryDate > dateTo) return false;
        }
        
        return true;
    });
    
    displayHistory();
}

// Exibe o hist√≥rico filtrado
function displayHistory() {
    const contentDiv = document.getElementById('history-content');
    const emptyDiv = document.getElementById('history-empty');
    const listDiv = document.getElementById('history-list');
    
    if (filteredHistoryData.length === 0) {
        contentDiv.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }
    
    listDiv.innerHTML = filteredHistoryData.map(entry => `
        <div class="history-item">
            <div class="history-main">
                <div class="history-model-badge ${entry.model.toLowerCase()}">
                    ${entry.modelDisplay}
                </div>
                <div class="history-action-badge ${entry.enabled ? 'enabled' : 'disabled'}">
                    ${entry.action}
                </div>
            </div>
            <div class="history-details">
                <div class="history-user">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke-width="2"/>
                        <circle cx="12" cy="7" r="4" stroke-width="2"/>
                    </svg>
                    ${entry.changedBy}
                </div>
                <div class="history-date">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke-width="2"/>
                        <polyline points="12,6 12,12 16,14" stroke-width="2"/>
                    </svg>
                    ${formatDateTime(entry.changedAt)}
                </div>
            </div>
        </div>
    `).join('');
    
    contentDiv.style.display = 'block';
    emptyDiv.style.display = 'none';
}

// Formata data e hora
function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toLocaleString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
    
    // Filtros de bot√£o
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            applyFilters();
        });
    });
    
    // Pesquisa
    document.getElementById('search-input').addEventListener('input', applyFilters);
    
    // Filtros de data
    document.getElementById('date-from').addEventListener('change', applyFilters);
    document.getElementById('date-to').addEventListener('change', applyFilters);
    
    // Limpar filtros
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('search-input').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('[data-filter="all"]').classList.add('active');
        applyFilters();
    });
    
    // Atualizar
    document.getElementById('refresh-history').addEventListener('click', loadHistory);
});
</script>
</body>
</html> 