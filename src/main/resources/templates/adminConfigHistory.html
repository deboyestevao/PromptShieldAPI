<!doctype html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/adminDashboard.css" rel="stylesheet" type="text/css">
    <link href="/css/adminConfigHistory.css" rel="stylesheet" type="text/css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <title>Histórico de Configurações - PromptShield</title>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <span class="logo-text">PromptShield</span>
                <span class="admin-badge">Admin</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-title">Dashboard</h3>
                <a href="/admin/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Visão Geral</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Gestão</h3>
                <a href="/admin/users" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Utilizadores</span>
                </a>
                <a href="/admin/reports" class="nav-item">
                    <i class="fas fa-flag"></i>
                    <span>Reports</span>
                </a>
                <a href="/admin/system-preferences" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
                <a href="/admin/config-history" class="nav-item active">
                    <i class="fas fa-history"></i>
                    <span>Histórico</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Sistema</h3>
                <a href="/chat" class="nav-item">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <div class="breadcrumb">
                    <span>Dashboard</span>
                    <i class="fas fa-chevron-right"></i>
                    <span>Histórico</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="notification-container">
                    <button class="notification-bell" id="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-count">0</span>
                    </button>
                    
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notificações</h3>
                            <button id="mark-all-read" class="mark-all-read-btn">
                                <i class="fas fa-check-double"></i>
                                Marcar todas
                            </button>
                        </div>
                        <div class="notification-list" id="notification-list">
                            <!-- Notificações serão carregadas aqui -->
                        </div>
                        <div class="notification-empty" id="notification-empty" style="display:none;">
                            <i class="fas fa-bell-slash"></i>
                            <p>Nenhuma notificação</p>
                        </div>
                    </div>
                </div>
                
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <span class="user-name">Administrador</span>
                        <span class="user-role">Admin</span>
                    </div>
                    <a href="/auth/logout" class="logout-link" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- Config History Content -->
        <div class="config-history-container">
            <div class="page-header">
                <h1>Histórico de Configurações do Sistema</h1>
                <p>Acompanhe todas as alterações feitas nas configurações do sistema</p>
            </div>
    
    <!-- Filtros e Pesquisa -->
    <section class="admin-filters-section">
        <div class="filters-container">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Pesquisar por utilizador..." class="search-input">
                <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8" stroke-width="2"/>
                    <path d="m21 21-4.35-4.35" stroke-width="2"/>
                </svg>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="openai">OpenAI</button>
                <button class="filter-btn" data-filter="ollama">Ollama</button>
                <button class="filter-btn" data-filter="enabled">Ativados</button>
                <button class="filter-btn" data-filter="disabled">Desativados</button>
            </div>
            
            <div class="date-filter">
                <label for="date-from">De:</label>
                <input type="date" id="date-from" class="date-input">
                <label for="date-to">Até:</label>
                <input type="date" id="date-to" class="date-input">
                <button id="clear-filters" class="clear-filters-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z" stroke-width="2"/>
                    </svg>
                    Limpar Filtros
                </button>
            </div>
        </div>
    </section>

    <!-- Estatísticas -->
    <section class="admin-stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-number" id="total-entries">0</div>
                <div class="stat-label">Total de Entradas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-number" id="openai-entries">0</div>
                <div class="stat-label">Alterações OpenAI</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-number" id="ollama-entries">0</div>
                <div class="stat-label">Alterações Ollama</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-number" id="unique-users">0</div>
                <div class="stat-label">Utilizadores Únicos</div>
            </div>
        </div>
    </section>

    <!-- Lista de Histórico -->
    <section class="admin-history-section">
        <div class="history-header">
            <h2>Registos de Alterações</h2>
            <div class="history-controls">
                <button id="refresh-history" class="refresh-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M1 4v6h6M23 20v-6h-6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4-4.64 4.36A9 9 0 0 1 3.51 15" stroke-width="2"/>
                    </svg>
                    Atualizar
                </button>
            </div>
        </div>

        <div id="history-loading" class="history-loading">
            <div class="loading-spinner"></div>
            <span>A carregar histórico...</span>
        </div>

        <div id="history-content" class="history-content" style="display:none;">
            <div id="history-list" class="history-list"></div>
        </div>

        <div id="history-empty" class="history-empty" style="display:none;">
            <div class="empty-icon">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z" stroke-width="2"/>
                </svg>
            </div>
            <h3>Nenhum registo encontrado</h3>
            <p>Não foram encontrados registos de alterações com os filtros aplicados.</p>
        </div>

        <div id="history-error" class="history-error" style="display:none;">
            <div class="error-icon">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01" stroke-width="2"/>
                </svg>
            </div>
            <h3>Erro ao carregar histórico</h3>
            <p>Ocorreu um erro ao carregar o histórico de configurações.</p>
            <button onclick="loadHistory()" class="retry-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M1 4v6h6M23 20v-6h-6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4-4.64 4.36A9 9 0 0 1 3.51 15" stroke-width="2"/>
                </svg>
                Tentar Novamente
            </button>
        </div>
    </section>
</main>

<script>
let allHistoryData = [];
let filteredHistoryData = [];

// Carrega o histórico
async function loadHistory() {
    const loadingDiv = document.getElementById('history-loading');
    const contentDiv = document.getElementById('history-content');
    const emptyDiv = document.getElementById('history-empty');
    const errorDiv = document.getElementById('history-error');
    
    loadingDiv.style.display = 'flex';
    contentDiv.style.display = 'none';
    emptyDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    
    try {
        const resp = await fetch('/admin/api/config-history');
        if (resp.ok) {
            allHistoryData = await resp.json();
            filteredHistoryData = [...allHistoryData];
            updateStats();
            applyFilters();
            // Esconder o loading após carregar com sucesso
            loadingDiv.style.display = 'none';
        } else {
            throw new Error('Erro ao carregar histórico');
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
    }
}

// Atualiza estatísticas
function updateStats() {
    const total = allHistoryData.length;
    const openai = allHistoryData.filter(entry => entry.model === 'OPENAI').length;
    const ollama = allHistoryData.filter(entry => entry.model === 'OLLAMA').length;
    const uniqueUsers = new Set(allHistoryData.map(entry => entry.changedBy)).size;
    
    document.getElementById('total-entries').textContent = total;
    document.getElementById('openai-entries').textContent = openai;
    document.getElementById('ollama-entries').textContent = ollama;
    document.getElementById('unique-users').textContent = uniqueUsers;
}

// Aplica filtros
function applyFilters() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    
    filteredHistoryData = allHistoryData.filter(entry => {
        // Filtro de pesquisa
        if (searchTerm && !entry.changedBy.toLowerCase().includes(searchTerm)) {
            return false;
        }
        
        // Filtro de modelo
        if (activeFilter !== 'all') {
            if (activeFilter === 'openai' && entry.model !== 'OPENAI') return false;
            if (activeFilter === 'ollama' && entry.model !== 'OLLAMA') return false;
            if (activeFilter === 'enabled' && !entry.enabled) return false;
            if (activeFilter === 'disabled' && entry.enabled) return false;
        }
        
        // Filtro de data
        if (dateFrom || dateTo) {
            const entryDate = new Date(entry.changedAt).toISOString().split('T')[0];
            if (dateFrom && entryDate < dateFrom) return false;
            if (dateTo && entryDate > dateTo) return false;
        }
        
        return true;
    });
    
    displayHistory();
}

// Exibe o histórico filtrado
function displayHistory() {
    const contentDiv = document.getElementById('history-content');
    const emptyDiv = document.getElementById('history-empty');
    const listDiv = document.getElementById('history-list');
    
    if (filteredHistoryData.length === 0) {
        contentDiv.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }
    
    listDiv.innerHTML = filteredHistoryData.map(entry => `
        <div class="history-item">
            <div class="history-main">
                <div class="history-model-badge ${entry.model.toLowerCase()}">
                    ${entry.modelDisplay}
                </div>
                <div class="history-action-badge ${entry.enabled ? 'enabled' : 'disabled'}">
                    ${entry.action}
                </div>
            </div>
            <div class="history-details">
                <div class="history-user">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke-width="2"/>
                        <circle cx="12" cy="7" r="4" stroke-width="2"/>
                    </svg>
                    ${entry.changedBy}
                </div>
                <div class="history-date">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke-width="2"/>
                        <polyline points="12,6 12,12 16,14" stroke-width="2"/>
                    </svg>
                    ${formatDateTime(entry.changedAt)}
                </div>
            </div>
        </div>
    `).join('');
    
    contentDiv.style.display = 'block';
    emptyDiv.style.display = 'none';
}

// Formata data e hora
function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toLocaleString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
    
    // Filtros de botão
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            applyFilters();
        });
    });
    
    // Pesquisa
    document.getElementById('search-input').addEventListener('input', applyFilters);
    
    // Filtros de data
    document.getElementById('date-from').addEventListener('change', applyFilters);
    document.getElementById('date-to').addEventListener('change', applyFilters);
    
    // Limpar filtros
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('search-input').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('[data-filter="all"]').classList.add('active');
        applyFilters();
    });
    
    // Atualizar
    document.getElementById('refresh-history').addEventListener('click', loadHistory);
        });
    </script>
    </main>
</body>
</html> 