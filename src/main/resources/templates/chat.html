<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptShield - Chat Seguro</title>
    <link rel="stylesheet" th:href="@{/css/chat.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="chat-layout">
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-comments"></i> Conversas</h3>
            </div>
            
            <div class="sidebar-chats" id="sidebar-chats">
                <!-- Lista de conversas ser√° preenchida dinamicamente -->
            </div>
            
            <div class="sidebar-actions">
                <button id="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    <span class="btn-text">Nova Conversa</span>
                </button>
                <button id="settings-btn" title="Prefer√™ncias">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- √Årea principal do chat -->
        <div class="container-chat">
            <!-- Header -->
            <div class="chat-header">
                <div class="header-left">
                    <div class="logo">
                        <h1>PromptShield</h1>
                    </div>
                    <a href="/admin/dashboard" class="dashboard-link" id="dashboard-btn" style="display:none;">
                        <i class="fas fa-chart-bar"></i> Dashboard
                    </a>
                </div>
                
                <div class="user-info">
                    <span>Ol√°, <span id="username" th:text="${username}">utilizador</span>!</span>
                    <a href="/auth/logout" class="logout-link">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                </div>
            </div>

            <!-- √Årea principal -->
            <div class="chat-main">
                <div class="chat-messages" id="chat-messages">
                    <!-- Mensagem de boas-vindas -->
                    <div id="welcome-message" class="welcome-message">
                        <div class="welcome-content">
                            <h2><i class="fas fa-shield-alt"></i> Bem-vindo ao PromptShield</h2>
                            <p>Comece uma nova conversa para come√ßar a usar a IA de forma segura.</p>
                            
                            <div class="welcome-features">
                                <div class="feature-card">
                                    <div class="feature-icon">
                                        <i class="fas fa-file-upload"></i>
                                    </div>
                                    <div>
                                        <div class="feature-title">Upload de Ficheiros</div>
                                        <div class="feature-desc">Analise documentos com IA segura</div>
                                    </div>
                                </div>
                                
                                <div class="feature-card">
                                    <div class="feature-icon">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <div>
                                        <div class="feature-title">Chat Inteligente</div>
                                        <div class="feature-desc">Conversas privadas e seguras</div>
                                    </div>
                                </div>
                                
                                <div class="feature-card">
                                    <div class="feature-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <div class="feature-title">Prote√ß√£o de Dados</div>
                                        <div class="feature-desc">Seus dados sempre protegidos</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="welcome-tips">
                                <p><strong>üí° Dica:</strong> Pode anexar ficheiros para an√°lise ou fazer perguntas diretas.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio de chat -->
                <div class="chat-form">
                    <form id="chat-form" autocomplete="off">
                <div id="file-chip" class="file-chip" style="display:none;"></div>
                <div class="input-group">
                            <label for="file-upload" class="upload-label" title="Anexar ficheiro">
                                <i class="fas fa-paperclip"></i>
                    </label>
                            <input type="file" id="file-upload" name="files" multiple style="display: none;">
                            <textarea id="question" name="question" class="form-control" placeholder="Escreva a sua mensagem..." required autofocus rows="1"></textarea>
                            <button type="submit" class="btn btn-primary" title="Enviar mensagem">
                                <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
                </div>
    </div>
        </div>
    </div>

    <!-- Modal de prefer√™ncias -->
    <div id="llm-prefs-modal" class="llm-prefs-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Prefer√™ncias de IA</h2>
                <button class="close-btn" id="close-prefs-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="llm-options">
                    <h3>Modelos de Linguagem Preferidos</h3>
                    <p>Selecione quais modelos de IA deseja utilizar:</p>
                    
                    <div id="llm-checkbox-list" class="checkbox-grid">
                        <!-- Checkboxes ser√£o gerados dinamicamente -->
                    </div>
                    
                    <div class="save-actions">
                        <button type="submit" id="save-prefs-btn" class="save-btn" disabled>
                            <i class="fas fa-save"></i>
                            <span class="save-text">Salvar Altera√ß√µes</span>
        </button>
                    </div>
                    
                    <div id="llm-status-info" class="status-grid">
                        <!-- Status ser√° gerado dinamicamente -->
                    </div>
                    
                    <div id="llm-prefs-feedback" class="feedback-message"></div>
                </div>
            </div>
        </div>
</div>

<script>
// Busca nome do utilizador autenticado
fetch('/ai/welcome').then(r => r.text()).then(txt => {
    const match = txt.match(/Bem vindo\/a (.+)/);
    if (match) document.getElementById('username').textContent = match[1];
});

// Fun√ß√£o para mostrar o bot√£o Dashboard se for admin
fetch('/ai/role').then(r => r.text()).then(role => {
    if (role.trim().toLowerCase() === 'admin') {
        document.getElementById('dashboard-btn').style.display = 'block';
    }
});

// Carrega status dos LLMs e prefer√™ncias do user e gera checkboxes
let lastPrefs = {};
async function loadLLMStatusAndPrefs() {
        try {
            const [statusResp, prefsResp, maintenanceResp] = await Promise.all([
                fetch('/admin/llm-status-simple'),
                fetch('/admin/llm-user-prefs'),
                fetch('/admin/llm-maintenance-status')
            ]);
            
            const status = await statusResp.json();
            const prefs = await prefsResp.json();
            const maintenance = await maintenanceResp.json();
    lastPrefs = { ...prefs };
            
    // Gera checkboxes
    const list = document.getElementById('llm-checkbox-list');
    list.innerHTML = '';
    Object.keys(status).forEach(llm => {
        const checked = !!prefs[llm];
        const disabled = !status[llm];
        const inMaintenance = maintenance[llm] && maintenance[llm].inMaintenance;
        
        const label = document.createElement('label');
        label.className = 'llm-checkbox-label' + (disabled ? ' llm-disabled' : '') + (inMaintenance ? ' llm-maintenance' : '');
        
        let labelText = `${llm.charAt(0).toUpperCase() + llm.slice(1)}`;
        if (inMaintenance) {
            labelText += ` (Em manuten√ß√£o at√© ${formatDateTime(maintenance[llm].until)})`;
        }
        
        label.innerHTML = `<input type="checkbox" name="llm-${llm}" value="${llm}" ${checked ? 'checked' : ''} ${disabled ? 'disabled' : ''}> ${labelText}`;
        list.appendChild(label);
    });
            
            // Adiciona listeners aos checkboxes
            addCheckboxListeners();
            
            // Verifica mudan√ßas iniciais
            checkForChanges();
            
    // Mostra info
    document.getElementById('llm-status-info').innerHTML =
                Object.entries(status).map(([llm, active]) => {
                    const inMaintenance = maintenance[llm] && maintenance[llm].inMaintenance;
                    let statusText = active ? 'Ativo' : 'Inativo';
                    let statusClass = active ? 'active' : 'inactive';
                    
                    if (inMaintenance) {
                        statusText = 'Em manuten√ß√£o';
                        statusClass = 'maintenance';
                    }
                    
                    return `
                        <div class="llm-status ${statusClass}">
                            <i class="fas fa-${active && !inMaintenance ? 'check-circle' : inMaintenance ? 'tools' : 'times-circle'}"></i>
                            ${llm.charAt(0).toUpperCase() + llm.slice(1)}: ${statusText}
                        </div>
                    `;
                }).join('');
                
            // Mostrar mensagem de manuten√ß√£o se necess√°rio
            showMaintenanceMessage(maintenance);
        } catch (error) {
            console.error('Erro ao carregar status/prefer√™ncias:', error);
        }
    }

// Fun√ß√£o para mostrar mensagem de manuten√ß√£o
function showMaintenanceMessage(maintenance) {
    const maintenanceModels = [];
    
    if (maintenance.openai && maintenance.openai.inMaintenance) {
        maintenanceModels.push({
            name: 'OpenAI',
            until: maintenance.openai.until,
            reason: maintenance.openai.reason
        });
    }
    
    if (maintenance.ollama && maintenance.ollama.inMaintenance) {
        maintenanceModels.push({
            name: 'Ollama',
            until: maintenance.ollama.until,
            reason: maintenance.ollama.reason
        });
    }
    
    if (maintenanceModels.length > 0) {
        const message = maintenanceModels.map(model => 
            `${model.name} est√° em manuten√ß√£o at√© ${formatDateTime(model.until)}. Motivo: ${model.reason}`
        ).join('<br>');
        
        // Criar ou atualizar mensagem de manuten√ß√£o
        let maintenanceDiv = document.getElementById('maintenance-message');
        if (!maintenanceDiv) {
            maintenanceDiv = document.createElement('div');
            maintenanceDiv.id = 'maintenance-message';
            maintenanceDiv.className = 'maintenance-message';
            maintenanceDiv.innerHTML = `
                <div class="maintenance-content">
                    <i class="fas fa-tools"></i>
                    <div class="maintenance-text">
                        <strong>Manuten√ß√£o em Curso</strong><br>
                        ${message}
                    </div>
                    <button class="maintenance-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Inserir no in√≠cio da √°rea de chat
            const chatMain = document.querySelector('.chat-main');
            chatMain.insertBefore(maintenanceDiv, chatMain.firstChild);
        } else {
            maintenanceDiv.querySelector('.maintenance-text').innerHTML = `
                <strong>Manuten√ß√£o em Curso</strong><br>
                ${message}
            `;
        }
    } else {
        // Remover mensagem se n√£o h√° manuten√ß√£o
        const maintenanceDiv = document.getElementById('maintenance-message');
        if (maintenanceDiv) {
            maintenanceDiv.remove();
        }
    }
}

// Ativa bot√£o se houver altera√ß√µes
    function checkForChanges() {
        const checkboxes = document.querySelectorAll('#llm-checkbox-list input[type=checkbox]');
    let changed = false;
    checkboxes.forEach(cb => {
        if (lastPrefs[cb.value] !== cb.checked) changed = true;
    });
    document.getElementById('save-prefs-btn').disabled = !changed;
    }

    // Adiciona event listeners aos checkboxes quando s√£o criados
    function addCheckboxListeners() {
        const checkboxes = document.querySelectorAll('#llm-checkbox-list input[type=checkbox]');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', checkForChanges);
        });
    }

// Guardar prefer√™ncias
    document.getElementById('save-prefs-btn').addEventListener('click', async function(e) {
    e.preventDefault();
        const checkboxes = document.querySelectorAll('#llm-checkbox-list input[type=checkbox]');
    const prefs = {};
    checkboxes.forEach(cb => {
        prefs[cb.value] = cb.checked;
    });
    const btn = document.getElementById('save-prefs-btn');
    btn.disabled = true;
    const feedback = document.getElementById('llm-prefs-feedback');
    feedback.textContent = 'A guardar...';
        feedback.className = 'feedback-message';
    try {
        await fetch('/admin/llm-user-prefs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(prefs)
        });
        feedback.textContent = 'Prefer√™ncias guardadas com sucesso!';
            feedback.className = 'feedback-message success';
        lastPrefs = { ...prefs };
            checkForChanges(); // Verifica se ainda h√° mudan√ßas
            setTimeout(() => {
                feedback.textContent = '';
                feedback.className = 'feedback-message';
            }, 2000);
    } catch {
        feedback.textContent = 'Erro ao guardar prefer√™ncias.';
            feedback.className = 'feedback-message error';
    }
});

// Mostrar aba do ficheiro carregado junto ao input
const fileInput = document.getElementById('file-upload');
const fileChip = document.getElementById('file-chip');
fileInput.addEventListener('change', function() {
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileChip.innerHTML = `<span class='file-chip-icon'>üìé</span> <span class='file-chip-name'>${file.name}</span> <span class='file-chip-remove' title='Remover'>&times;</span>`;
        fileChip.style.display = 'flex';
    } else {
        fileChip.style.display = 'none';
    }
});
fileChip.addEventListener('click', function(e) {
    if (e.target.classList.contains('file-chip-remove')) {
        fileInput.value = '';
        fileChip.style.display = 'none';
    }
});

    // Fun√ß√£o para mostrar mensagem de boas-vindas moderna
    function showWelcomeMessage() {
        let welcomeMessage = document.getElementById('welcome-message');
        
        // Se o elemento n√£o existe, recri√°-lo com o design moderno
        if (!welcomeMessage) {
            welcomeMessage = document.createElement('div');
            welcomeMessage.id = 'welcome-message';
            welcomeMessage.className = 'welcome-message';
            welcomeMessage.innerHTML = `
                <div class="welcome-content">
                    <h2><i class="fas fa-shield-alt"></i> Bem-vindo ao PromptShield</h2>
                    <p>Comece uma nova conversa para come√ßar a usar a IA de forma segura.</p>
                    
                    <div class="welcome-features">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-file-upload"></i>
                            </div>
                            <div>
                                <div class="feature-title">Upload de Ficheiros</div>
                                <div class="feature-desc">Analise documentos com IA segura</div>
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div>
                                <div class="feature-title">Chat Inteligente</div>
                                <div class="feature-desc">Conversas privadas e seguras</div>
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-lock"></i>
                            </div>
                            <div>
                                <div class="feature-title">Prote√ß√£o de Dados</div>
                                <div class="feature-desc">Seus dados sempre protegidos</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="welcome-tips">
                        <p><strong>üí° Dica:</strong> Pode anexar ficheiros para an√°lise ou fazer perguntas diretas.</p>
                    </div>
                </div>
            `;
            chatMessages.appendChild(welcomeMessage);
        }
        
        welcomeMessage.style.display = 'flex';
    }

    // Fun√ß√£o para esconder mensagem de boas-vindas
    function hideWelcomeMessage() {
        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) {
            welcomeMessage.style.display = 'none';
        }
    }

// === MULTICHAT UI MODERNA ===
let currentChatId = null;
const sidebarChats = document.getElementById('sidebar-chats');
const chatMessages = document.getElementById('chat-messages');

async function loadChats() {
    const chats = await fetch('/api/chat').then(r => r.json());
    sidebarChats.innerHTML = '';
        
        // Se n√£o h√° chats, mostrar mensagem de estado vazio
        if (chats.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'empty-chats-message';
            emptyMessage.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 200px; padding: 20px; background: #fff; border-radius: 12px; margin: 10px; border: 1px solid rgba(24, 60, 124, 0.1);';
            emptyMessage.innerHTML = `
                <div class="empty-chats-content" style="text-align: center; color: #64748b;">
                    <p style="margin: 0 0 8px 0; font-size: 1rem; font-weight: 500; color: #475569;">Nenhum chat ainda</p>
                    <small style="font-size: 0.85rem; opacity: 0.8; color: #94a3b8;">Clique em + para come√ßar</small>
                </div>
            `;
            sidebarChats.appendChild(emptyMessage);
            return;
        }
        
    chats.forEach((chat, idx) => {
        const div = document.createElement('div');
        div.className = 'chat-list-item' + (currentChatId===chat.id?' selected':'');
        
        // Mostrar nome do chat ou "Novo chat" se estiver vazio
        const chatName = chat.name && chat.name.trim() !== '' ? chat.name : 'Novo chat';
        div.textContent = chatName;
        
        div.onclick = () => selectChat(chat.id);
        // Bot√£o deletar (SVG minimalista)
        const del = document.createElement('button');
        del.className = 'delete-chat-btn';
        del.title = 'Apagar chat';
        del.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
        del.onclick = (e) => { e.stopPropagation(); deleteChat(chat.id); };
        div.appendChild(del);
        sidebarChats.appendChild(div);
    });
}
async function selectChat(chatId) {
    currentChatId = chatId;
    await loadChats();
    // Limpa mensagens
    chatMessages.innerHTML = '';
    // Carrega hist√≥rico
    const hist = await fetch(`/api/chat/${chatId}/questions`).then(r=>r.json());
        
    // Se h√° hist√≥rico, mostrar as mensagens
    if (hist.length > 0) {
        hideWelcomeMessage();
        
        hist.forEach(q => {
            // Para o hist√≥rico, n√£o temos informa√ß√£o sobre ficheiros anexados
            // mas podemos detectar se a pergunta cont√©m conte√∫do de ficheiro
            let attachedFileName = null;
            let displayQuestion = q.question;
            
            if (q.question && q.question.includes('--- Conte√∫do de')) {
                // Extrai o nome do ficheiro da pergunta
                const match = q.question.match(/--- Conte√∫do de (.+?) ---/);
                if (match) {
                    attachedFileName = match[1];
                    // Remove o conte√∫do do ficheiro da pergunta exibida
                    const questionMatch = q.question.match(/Pergunta:\s*(.+)$/);
                    if (questionMatch) {
                        displayQuestion = questionMatch[1].trim();
                    } else {
                        displayQuestion = "Pergunta sobre ficheiro anexado";
                    }
                }
            }
            
            addMessage('Voc√™', displayQuestion, 'user', false, attachedFileName);
            addMessage(
                q.model ? (q.model.charAt(0).toUpperCase() + q.model.slice(1)) : 'LLM',
                q.answer, 'llm-' + (q.model ? q.model.toLowerCase() : 'llm')
            );
        });
    } else {
        // Se n√£o h√° hist√≥rico, mostrar mensagem de boas-vindas moderna
        showWelcomeMessage();
    }
    
    // Scroll para baixo ap√≥s carregar hist√≥rico
    setTimeout(scrollToBottom, 100);
}
async function deleteChat(chatId) {
    try {
        const response = await fetch(`/api/chat/${chatId}`, {method:'DELETE'});
        if (response.ok) {
            const responseData = await response.json();
            if(currentChatId===chatId) currentChatId=null;
            await loadChats();
                
                // Limpar mensagens e mostrar boas-vindas
            chatMessages.innerHTML = '';
                
                // Aguardar um pouco antes de mostrar a mensagem de boas-vindas
                setTimeout(() => {
                    showWelcomeMessage();
                }, 100);
                
            // Mostrar mensagem de sucesso
            if (responseData.message) {
                // Criar uma notifica√ß√£o tempor√°ria
                const notification = document.createElement('div');
                notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:12px 20px;border-radius:8px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
                notification.textContent = responseData.message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        } else {
            const errorData = await response.json();
            alert('Erro ao apagar chat: ' + (errorData.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao apagar chat:', error);
        alert('Erro ao apagar chat. Tente novamente.');
    }
}
document.getElementById('new-chat-btn').addEventListener('click', async function() {
    // Cria chat vazio (sem nome)
    const chat = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name: ''})
    }).then(r=>r.json());
    currentChatId = chat.id;
    await loadChats();
    
    // Limpa mensagens e mostra mensagem de boas-vindas moderna
    chatMessages.innerHTML = '';
    showWelcomeMessage();
    document.getElementById('question').focus();
});
// Carrega chats ao iniciar
loadChats();

// Garantir que o input fica sempre vis√≠vel quando clicado
document.getElementById('question').addEventListener('focus', function() {
    setTimeout(scrollToBottom, 100);
});

    // Permitir CTRL + Enter para quebra de linha e Enter para enviar
    document.getElementById('question').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (e.ctrlKey) {
                // CTRL + Enter: quebra de linha
                e.preventDefault();
                const textarea = this;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;
                
                // Insere quebra de linha na posi√ß√£o do cursor
                textarea.value = value.substring(0, start) + '\n' + value.substring(end);
                
                // Reposiciona o cursor ap√≥s a quebra de linha
                textarea.selectionStart = textarea.selectionEnd = start + 1;
                
                // Ajusta a altura do textarea
                autoResize(textarea);
            } else if (!e.shiftKey) {
                // Enter (sem CTRL nem SHIFT): envia a mensagem
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
            // SHIFT + Enter: comportamento padr√£o (quebra de linha)
        }
    });

    // Auto-resize do textarea
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // Aplicar auto-resize quando o conte√∫do muda
    document.getElementById('question').addEventListener('input', function() {
        autoResize(this);
    });

// Scroll para baixo quando a p√°gina carrega
window.addEventListener('load', function() {
    setTimeout(scrollToBottom, 200);
});

// L√≥gica de envio de mensagem e upload de ficheiros
const chatForm = document.getElementById('chat-form');

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
        let question = document.getElementById('question').value.trim();
        if (!question) return;

    // Se n√£o houver chat selecionado, cria um novo com o nome igual √† primeira frase
    if (!currentChatId) {
        let firstSentence = question.split(/[.!?]/)[0];
        if (firstSentence.length > 30) firstSentence = firstSentence.slice(0, 30) + '...';
        const chat = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: firstSentence })
        }).then(r => r.json());
        currentChatId = chat.id;
        await loadChats();
    } else {
        // Se o chat selecionado n√£o tem nome (chat vazio), atualiza o nome na primeira mensagem
        const selectedChat = Array.from(document.querySelectorAll('.chat-list-item')).find(div => div.classList.contains('selected'));
        if (selectedChat && (selectedChat.textContent.trim() === '' || selectedChat.textContent.trim() === 'Chat ' + currentChatId || selectedChat.textContent.trim() === 'Novo chat')) {
            let firstSentence = question.split(/[.!?]/)[0];
            if (firstSentence.length > 30) firstSentence = firstSentence.slice(0, 30) + '...';
            try {
                const updateResponse = await fetch(`/api/chat/${currentChatId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: firstSentence })
                });
                if (updateResponse.ok) {
                    await loadChats();
                }
            } catch (error) {
                console.error('Erro ao atualizar nome do chat:', error);
            }
        }
    }

    let fileIds = [];
    if (fileInput.files.length > 0) {
        const formData = new FormData();
        for (const file of fileInput.files) {
            formData.append('files', file);
        }
        const uploadResp = await fetch('/files/upload', { method: 'POST', body: formData });
        if (uploadResp.ok) {
            fileIds = await uploadResp.json();
        } else {
            alert('Erro ao fazer upload dos ficheiros.');
            return;
        }
    }
        // Guarda o nome do ficheiro antes de limpar o input
        let attachedFileName = null;
        if (fileInput.files.length > 0) {
            attachedFileName = fileInput.files[0].name;
        }
        
    fileInput.value = '';
    fileChip.style.display = 'none';
        
        // Limpa o textarea e reseta a altura
        const textarea = document.getElementById('question');
        textarea.value = '';
        textarea.style.height = '40px'; // Reset para altura m√≠nima
        
    const resp = await fetch('/ai/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, fileIds, chatId: currentChatId })
    });
    if (resp.ok) {
        const data = await resp.json();
            
        if (data.maskedQuestion) {
                // Mostra apenas a pergunta original, n√£o o conte√∫do dos ficheiros
                addMessage('Voc√™', data.maskedQuestion, 'user', false, attachedFileName);
        }
        if (data.llmAnswers && Array.isArray(data.llmAnswers)) {
                data.llmAnswers.forEach(ans => {
                    addLLMAnswers(ans);
                });
        }
    } else {
        addMessage('Erro', 'Falha ao obter resposta do chatbot.', 'error');
    }
});

function addLLMAnswers(answerText) {
        // Verifica se a resposta come√ßa com um identificador de modelo
        const modelMatch = answerText.match(/^(OpenAI|Ollama):\s*(.*)/i);
        
        if (modelMatch) {
            const model = modelMatch[1];
            const content = modelMatch[2];
            
            // Se h√° mais conte√∫do ap√≥s o identificador, inclui tudo
            const fullContent = answerText.substring(answerText.indexOf(':') + 1).trim();
            
            // Processa quebras de linha mantendo a formata√ß√£o
            const processedContent = fullContent
                .replace(/\n\n/g, '<br><br>') // Duplas quebras de linha
                .replace(/\n/g, '<br>'); // Quebras de linha simples
            
            addMessage(model, processedContent, 'llm-' + model.toLowerCase(), true);
        } else {
            // Se n√£o h√° identificador de modelo, trata como resposta gen√©rica
            const processedContent = answerText
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
            
            addMessage('LLM', processedContent, 'llm-llm', true);
        }
    }

    function addMessage(author, text, type, typingEffect = false, attachedFile = null) {
        // Esconder mensagem de boas-vindas quando a primeira mensagem √© adicionada
        hideWelcomeMessage();
        
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-message ' + type;
        
        // Se h√° ficheiro anexado, adiciona o chip do ficheiro
        let fileChipHTML = '';
        if (attachedFile) {
            fileChipHTML = `
                <div class="message-file-chip">
                    <span class="file-chip-icon">üìé</span>
                    <span class="file-chip-name">${attachedFile}</span>
                </div>
            `;
        }
        
        msgDiv.innerHTML = `
            <strong>${author}:</strong>
            ${fileChipHTML}
            <span class="message-content"></span>
        `;
    chatMessages.appendChild(msgDiv);
    
    // Scroll para baixo imediatamente
    scrollToBottom();
    
        const span = msgDiv.querySelector('.message-content');
        
        // Processa o texto para quebras de linha adequadas
        const processedText = text
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
        
    if (typingEffect) {
            // Para efeito de digita√ß√£o com HTML, vamos processar de forma diferente
            const textWithoutHTML = text.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
        let i = 0;
            let currentHTML = '';
            
        function typeChar() {
                if (i <= textWithoutHTML.length) {
                    // Reconstr√≥i o HTML progressivamente
                    const currentText = textWithoutHTML.slice(0, i);
                    currentHTML = currentText.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
                    span.innerHTML = currentHTML;
                scrollToBottom();
                i++;
                setTimeout(typeChar, 8); // velocidade do efeito
            } else {
                    // Garante que o HTML final est√° correto
                    span.innerHTML = processedText;
                scrollToBottom();
            }
        }
        typeChar();
    } else {
            span.innerHTML = processedText;
        scrollToBottom();
    }
}

// Fun√ß√£o para scroll suave para baixo
function scrollToBottom() {
    chatMessages.scrollTo({
        top: chatMessages.scrollHeight,
        behavior: 'smooth'
    });
}

// Prefer√™ncias de LLM em modal
const llmPrefsModal = document.getElementById('llm-prefs-modal');
    const settingsBtn = document.getElementById('settings-btn');
    const closePrefsBtn = document.getElementById('close-prefs-btn');
    
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
    llmPrefsModal.style.display = 'flex';
            loadLLMStatusAndPrefs();
        });
    }
    
    if (closePrefsBtn) {
        closePrefsBtn.addEventListener('click', () => {
            llmPrefsModal.style.display = 'none';
        });
    }
    
    // Fechar modal ao clicar no overlay
    const modalOverlay = document.querySelector('.modal-overlay');
    if (modalOverlay) {
        modalOverlay.addEventListener('click', () => {
    llmPrefsModal.style.display = 'none';
        });
    }
</script>
</body>
</html> 