<!doctype html>
<html lang="pt" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/chat.css" rel="stylesheet" type="text/css">
    <title>PromptShield - Chat</title>
</head>
<body>
<div class="chat-layout">
    <div class="container-chat">
        <header class="chat-header">
            <div class="header-left">
                <div class="logo"><h1>PromptShield</h1></div>
                <div id="dashboard-btn" style="display:none; margin-right:18px;"></div>
            </div>
            <div class="user-info">Olá, <span id="username">Utilizador</span>! <a href="/auth/logout" class="logout-link">Sair</a></div>
        </header>
        <main class="chat-main">
            <div id="chat-messages" class="chat-messages">
                <!-- Mensagens do chat aparecem aqui -->
            </div>
            <form id="chat-form" class="chat-form" autocomplete="off">
                <div id="file-chip" class="file-chip" style="display:none;"></div>
                <div class="input-group">
                    <label for="file-upload" class="upload-label" title="Enviar ficheiro">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#183c7c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <input type="file" id="file-upload" name="files" multiple class="file-input" style="display:none;">
                    </label>
                    <input type="text" id="question" name="question" class="form-control" placeholder="Escreva a sua mensagem..." required autofocus>
                    <button type="submit" class="btn btn-primary" title="Enviar">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </form>
        </main>
    </div>
    <aside class="chat-sidebar">
        <div class="sidebar-header">
            <button id="new-chat-btn" title="Basta começar a escrever para criar um novo chat" tabindex="0">+</button>
        </div>
        <div class="sidebar-chats" id="sidebar-chats"></div>
        <button id="settings-btn" title="Preferências">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#183c7c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09A1.65 1.65 0 0 0 16 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 8c.14.31.22.65.22 1v.09A1.65 1.65 0 0 0 21 12c0 .35-.08.69-.22 1z"/>
            </svg>
        </button>
        <div id="llm-prefs-modal" class="llm-prefs-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(24,60,124,0.10);z-index:1000;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:32px 28px 24px 28px;border-radius:18px;box-shadow:0 8px 32px #183c7c22;min-width:320px;max-width:90vw;position:relative;">
                <button id="close-prefs-btn" style="position:absolute;top:12px;right:12px;background:transparent;border:none;font-size:1.5em;cursor:pointer;">&times;</button>
                <h2 style="margin-top:0;">Preferências de LLM</h2>
                <form id="llm-preferences-form">
                    <div id="llm-checkbox-list"></div>
                    <button type="submit" id="save-prefs-btn" class="btn btn-secondary" disabled>Guardar preferências</button>
                </form>
                <div id="llm-status-info" class="llm-status-info"></div>
                <div id="llm-prefs-feedback" class="llm-prefs-feedback"></div>
            </div>
        </div>
    </aside>
</div>
<style>
.chat-sidebar {
    position: relative;
    width: 260px;
    min-width: 180px;
    max-width: 260px;
    background: #f8f9fa;
    border-radius: 0 0 0 24px;
    box-shadow: -8px 0 32px rgba(24,60,124,0.10);
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    border: none;
    height: 100vh;
    min-height: 0;
    z-index: 10;
    overflow-x: hidden;
}
.sidebar-header {
    padding: 18px 0 10px 0;
    background: #fff;
    border-bottom: 1.5px solid #e1e5e9;
    position: sticky;
    top: 0;
    z-index: 2;
    display: flex;
    justify-content: center;
    align-items: center;
}
#new-chat-btn {
    background: #183c7c;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    font-size: 1.5em;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px #183c7c22;
    display: flex;
    align-items: center;
    justify-content: center;
}
#new-chat-btn:hover, #new-chat-btn:focus {
    background: #1450b8;
    outline: none;
}
.sidebar-chats {
    flex: 1 1 auto;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
}
.chat-list-item {
    width: 100%;
    padding: 12px 16px;
    font-size: 1em;
    border: none;
    border-radius: 0;
    display: flex;
    align-items: center;
    transition: background 0.18s, color 0.18s;
    cursor: pointer;
    position: relative;
    min-height: 40px;
    user-select: none;
    box-sizing: border-box;
    overflow-x: hidden;
}
.chat-list-item.selected {
    background: #e3eafc !important;
    color: #183c7c;
    font-weight: bold;
}
.chat-list-item:hover {
    background: #e8f0fe;
}
.delete-chat-btn {
    margin-left: auto;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    transition: background 0.15s;
    display: flex;
    align-items: center;
}
.delete-chat-btn:hover {
    background: #f2f2f2;
}
#settings-btn {
    position: absolute;
    bottom: 18px;
    right: 18px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: none;
    width: 38px;
    height: 38px;
}
#settings-btn svg {
    display: block;
    margin: 0 auto;
    transform: rotate(0deg);
}
.llm-prefs-modal {
    display: flex;
}
@media (max-width: 900px) {
    .chat-sidebar {
        min-width: 0;
        max-width: 100vw;
        width: 100vw;
        border-radius: 0 0 24px 24px;
        height: auto;
        position: static;
        right: unset;
        top: unset;
        transform: none;
        margin: 0;
        padding: 16px 0 12px 0;
    }
}
</style>
<script>
// Busca nome do utilizador autenticado
fetch('/ai/welcome').then(r => r.text()).then(txt => {
    const match = txt.match(/Bem vindo\/a (.+)/);
    if (match) document.getElementById('username').textContent = match[1];
});

// Função para mostrar o botão Dashboard se for admin
fetch('/ai/role').then(r => r.text()).then(role => {
    if (role.trim().toLowerCase() === 'admin') {
        document.getElementById('dashboard-btn').innerHTML = '<a href="/admin/dashboard" class="dashboard-link">Dashboard</a>';
        document.getElementById('dashboard-btn').style.display = 'block';
    }
});

// Carrega status dos LLMs e preferências do user e gera checkboxes
let lastPrefs = {};
async function loadLLMStatusAndPrefs() {
    let status = {};
    let prefs = {};
    try {
        const statusResp = await fetch('/admin/llm-status');
        if (!statusResp.ok) {
            document.getElementById('llm-checkbox-list').innerHTML = '<span style="color:red">Erro ao carregar preferências de LLM.</span>';
            document.getElementById('llm-status-info').innerHTML = '';
            document.getElementById('save-prefs-btn').disabled = true;
            return;
        }
        status = await statusResp.json();
        const prefsResp = await fetch('/admin/llm-user-prefs');
        if (prefsResp.ok) {
            prefs = await prefsResp.json();
        }
    } catch {
        document.getElementById('llm-checkbox-list').innerHTML = '<span style="color:red">Erro ao carregar preferências de LLM.</span>';
        document.getElementById('llm-status-info').innerHTML = '';
        document.getElementById('save-prefs-btn').disabled = true;
        return;
    }
    lastPrefs = { ...prefs };
    // Gera checkboxes
    const list = document.getElementById('llm-checkbox-list');
    list.innerHTML = '';
    Object.keys(status).forEach(llm => {
        const checked = !!prefs[llm];
        const disabled = !status[llm];
        const label = document.createElement('label');
        label.className = 'llm-checkbox-label' + (disabled ? ' llm-disabled' : '');
        label.innerHTML = `<input type="checkbox" name="llm-${llm}" value="${llm}" ${checked ? 'checked' : ''} ${disabled ? 'disabled' : ''}> ${llm.charAt(0).toUpperCase() + llm.slice(1)}`;
        list.appendChild(label);
    });
    // Mostra info
    document.getElementById('llm-status-info').innerHTML =
        Object.entries(status).map(([llm, v]) => `<span class=\"llm-status ${v ? 'active' : 'inactive'}\">${llm.charAt(0).toUpperCase() + llm.slice(1)}: ${v ? 'Ativo' : 'Em baixo'}</span>`).join('<br>');
    document.getElementById('save-prefs-btn').disabled = true;
}
loadLLMStatusAndPrefs();

// Ativa botão se houver alterações
const llmForm = document.getElementById('llm-preferences-form');
llmForm.addEventListener('change', function() {
    const checkboxes = llmForm.querySelectorAll('input[type=checkbox]');
    let changed = false;
    checkboxes.forEach(cb => {
        if (lastPrefs[cb.value] !== cb.checked) changed = true;
    });
    document.getElementById('save-prefs-btn').disabled = !changed;
});

// Guardar preferências
llmForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const checkboxes = llmForm.querySelectorAll('input[type=checkbox]');
    const prefs = {};
    checkboxes.forEach(cb => {
        prefs[cb.value] = cb.checked;
    });
    const btn = document.getElementById('save-prefs-btn');
    btn.disabled = true;
    const feedback = document.getElementById('llm-prefs-feedback');
    feedback.textContent = 'A guardar...';
    try {
        await fetch('/admin/llm-user-prefs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(prefs)
        });
        feedback.textContent = 'Preferências guardadas com sucesso!';
        lastPrefs = { ...prefs };
        setTimeout(() => feedback.textContent = '', 2000);
    } catch {
        feedback.textContent = 'Erro ao guardar preferências.';
    }
});

// Mostrar aba do ficheiro carregado junto ao input
const fileInput = document.getElementById('file-upload');
const fileChip = document.getElementById('file-chip');
fileInput.addEventListener('change', function() {
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileChip.innerHTML = `<span class='file-chip-icon'>📎</span> <span class='file-chip-name'>${file.name}</span> <span class='file-chip-remove' title='Remover'>&times;</span>`;
        fileChip.style.display = 'flex';
    } else {
        fileChip.style.display = 'none';
    }
});
fileChip.addEventListener('click', function(e) {
    if (e.target.classList.contains('file-chip-remove')) {
        fileInput.value = '';
        fileChip.style.display = 'none';
    }
});

// === MULTICHAT UI MODERNA ===
let currentChatId = null;
const sidebarChats = document.getElementById('sidebar-chats');
const chatMessages = document.getElementById('chat-messages');

async function loadChats() {
    const chats = await fetch('/api/chat').then(r => r.json());
    sidebarChats.innerHTML = '';
    chats.forEach((chat, idx) => {
        const div = document.createElement('div');
        div.className = 'chat-list-item' + (currentChatId===chat.id?' selected':'');
        // Alternar cor de fundo
        div.style.background = idx%2===0 ? '#fff' : '#f3f6fa';
        div.textContent = chat.name || 'Chat ' + chat.id;
        div.onclick = () => selectChat(chat.id);
        // Botão deletar (SVG minimalista)
        const del = document.createElement('button');
        del.className = 'delete-chat-btn';
        del.title = 'Apagar chat';
        del.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#b0b0b0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
        del.onclick = (e) => { e.stopPropagation(); deleteChat(chat.id); };
        div.appendChild(del);
        sidebarChats.appendChild(div);
    });
}
async function selectChat(chatId) {
    currentChatId = chatId;
    await loadChats();
    // Limpa mensagens
    chatMessages.innerHTML = '';
    // Carrega histórico
    const hist = await fetch(`/api/chat/${chatId}/questions`).then(r=>r.json());
    hist.forEach(q => {
        addMessage('Você', q.question, 'user');
        addMessage('LLM', q.answer, 'llm-openai'); // ou llm-ollama se quiser diferenciar
    });
}
async function deleteChat(chatId) {
    await fetch(`/api/chat/${chatId}`, {method:'DELETE'});
    if(currentChatId===chatId) currentChatId=null;
    await loadChats();
    chatMessages.innerHTML = '';
}
document.getElementById('new-chat-btn').addEventListener('click', async function() {
    // Cria chat vazio (sem nome)
    const chat = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name: ''})
    }).then(r=>r.json());
    await loadChats();
    selectChat(chat.id);
});
// Carrega chats ao iniciar
loadChats();

// Lógica de envio de mensagem e upload de ficheiros
const chatForm = document.getElementById('chat-form');

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    let question = document.getElementById('question').value;
    if (!question.trim()) return;

    // Se não houver chat selecionado, cria um novo com o nome igual à primeira frase
    if (!currentChatId) {
        let firstSentence = question.split(/[.!?]/)[0];
        if (firstSentence.length > 30) firstSentence = firstSentence.slice(0, 30) + '...';
        const chat = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: firstSentence })
        }).then(r => r.json());
        currentChatId = chat.id;
        await loadChats();
    } else {
        // Se o chat selecionado não tem nome, atualiza o nome na primeira mensagem
        const selectedChat = Array.from(document.querySelectorAll('.chat-list-item')).find(div => div.classList.contains('selected'));
        if (selectedChat && selectedChat.textContent.trim() === '') {
            let firstSentence = question.split(/[.!?]/)[0];
            if (firstSentence.length > 30) firstSentence = firstSentence.slice(0, 30) + '...';
            await fetch(`/api/chat/${currentChatId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: firstSentence })
            });
            await loadChats();
        }
    }

    let fileIds = [];
    if (fileInput.files.length > 0) {
        const formData = new FormData();
        for (const file of fileInput.files) {
            formData.append('files', file);
        }
        const uploadResp = await fetch('/files/upload', { method: 'POST', body: formData });
        if (uploadResp.ok) {
            fileIds = await uploadResp.json();
        } else {
            alert('Erro ao fazer upload dos ficheiros.');
            return;
        }
    }
    fileInput.value = '';
    fileChip.style.display = 'none';
    document.getElementById('question').value = '';
    const resp = await fetch('/ai/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, fileIds, chatId: currentChatId })
    });
    if (resp.ok) {
        const data = await resp.json();
        if (data.maskedQuestion) {
            addMessage('Você', data.maskedQuestion, 'user');
        }
        if (data.llmAnswers && Array.isArray(data.llmAnswers)) {
            data.llmAnswers.forEach(ans => addLLMAnswers(ans));
        }
    } else {
        addMessage('Erro', 'Falha ao obter resposta do chatbot.', 'error');
    }
});

function addLLMAnswers(answerText) {
    // Agrupa todas as linhas do mesmo modelo numa só mensagem
    const lines = answerText.split(/\n+/).filter(Boolean);
    const llmMap = {};
    for (const line of lines) {
        const match = line.match(/^(OpenAI|Ollama):\s*(.*)$/i);
        if (match) {
            const llm = match[1];
            const msg = match[2];
            if (!llmMap[llm]) llmMap[llm] = [];
            llmMap[llm].push(msg);
        } else {
            // Não mostrar mensagens "LLM:" soltas
        }
    }
    for (const llm in llmMap) {
        addMessage(llm, llmMap[llm].join('<br>'), 'llm-' + llm.toLowerCase(), true);
    }
}

function addMessage(author, text, type, typingEffect = false) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-message ' + type;
    msgDiv.innerHTML = `<strong>${author}:</strong> <span></span>`;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    const span = msgDiv.querySelector('span');
    if (typingEffect) {
        let i = 0;
        function typeChar() {
            if (i <= text.length) {
                span.innerHTML = text.slice(0, i).replace(/\n/g, '<br>');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                i++;
                setTimeout(typeChar, 8); // velocidade do efeito
            } else {
                span.innerHTML = text.replace(/\n/g, '<br>');
            }
        }
        typeChar();
    } else {
        span.innerHTML = text.replace(/\n/g, '<br>');
    }
}
// Preferências de LLM em modal
const llmPrefsModal = document.getElementById('llm-prefs-modal');
document.getElementById('settings-btn').onclick = () => {
    llmPrefsModal.style.display = 'flex';
};
document.getElementById('close-prefs-btn').onclick = () => {
    llmPrefsModal.style.display = 'none';
};
</script>
</body>
</html> 