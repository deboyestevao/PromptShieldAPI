<!doctype html>
<html lang="pt" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/chat.css?v=1.1" rel="stylesheet" type="text/css">
    <title>PromptShield - Chat</title>
</head>
<body>
<div class="chat-layout">
    <div class="container-chat">
        <header class="chat-header">
            <div class="header-left">
                <div class="logo"><h1>PromptShield</h1></div>
                <div id="dashboard-btn" style="display:none; margin-right:18px;"></div>
            </div>
            <div class="user-info">Ol√°, <span id="username">Utilizador</span>! <a href="/auth/logout" class="logout-link">Sair</a></div>
        </header>
        <main class="chat-main">
            <div id="chat-messages" class="chat-messages">
                <!-- Mensagem de boas-vindas quando n√£o h√° mensagens -->
                <div id="welcome-message" class="welcome-message" style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 40px 20px;">
                    <div class="welcome-content" style="text-align: center; max-width: 500px; background: #fff; border-radius: 20px; padding: 40px 30px; box-shadow: 0 4px 20px rgba(24, 60, 124, 0.1); border: 1px solid rgba(24, 60, 124, 0.1);">
                        <h2 style="color: #183c7c; margin: 0 0 15px 0; font-size: 1.8rem; font-weight: 600;">Bem-vindo ao PromptShield</h2>
                        <p style="color: #64748b; margin: 0 0 20px 0; font-size: 1.1rem; line-height: 1.6;">Comece uma nova conversa para come√ßar a usar a IA de forma segura.</p>
                        <div class="welcome-tips" style="background: rgba(24, 60, 124, 0.05); border-radius: 12px; padding: 15px; border-left: 4px solid #183c7c;">
                            <p style="margin: 0; font-size: 0.95rem; color: #475569;"><strong>Dica:</strong> Pode anexar ficheiros para an√°lise ou fazer perguntas diretas.</p>
                        </div>
                    </div>
                </div>
                <!-- Mensagens do chat aparecem aqui -->
            </div>
            <form id="chat-form" class="chat-form" autocomplete="off">
                <div id="file-chip" class="file-chip" style="display:none;"></div>
                <div class="input-group">
                    <label for="file-upload" class="upload-label" title="Enviar ficheiro">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#183c7c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <input type="file" id="file-upload" name="files" multiple class="file-input" style="display:none;">
                    </label>
                    <input type="text" id="question" name="question" class="form-control" placeholder="Escreva a sua mensagem..." required autofocus>
                    <button type="submit" class="btn btn-primary" title="Enviar">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </form>
        </main>
    </div>
    <aside class="chat-sidebar">
        <div class="sidebar-header">
            <h3>Conversas</h3>
        </div>
        <div class="sidebar-chats" id="sidebar-chats">
            <!-- Os chats ser√£o carregados dinamicamente aqui -->
        </div>
        <div class="sidebar-actions">
            <button id="new-chat-btn" title="Basta come√ßar a escrever para criar um novo chat" tabindex="0">+</button>
            <button id="settings-btn" title="Prefer√™ncias">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#183c7c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </button>
        </div>
        <div id="llm-prefs-modal" class="llm-prefs-modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Prefer√™ncias de LLM</h2>
                    <button id="close-prefs-btn" class="close-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="llm-preferences-form">
                        <div class="llm-options">
                            <h3>Modelos Dispon√≠veis</h3>
                            <div id="llm-checkbox-list" class="checkbox-grid"></div>
                        </div>
                        <div class="llm-status-section">
                            <h3>Estado dos Servi√ßos</h3>
                            <div id="llm-status-info" class="status-grid"></div>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" id="save-prefs-btn" class="btn btn-primary" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17,21 17,13 7,13 7,21"></polyline>
                                    <polyline points="7,3 7,8 15,8"></polyline>
                                </svg>
                                Guardar Prefer√™ncias
                            </button>
                        </div>
                    </form>
                    <div id="llm-prefs-feedback" class="feedback-message"></div>
                </div>
            </div>
        </div>
    </aside>
</div>

<script>
// Busca nome do utilizador autenticado
fetch('/ai/welcome').then(r => r.text()).then(txt => {
    const match = txt.match(/Bem vindo\/a (.+)/);
    if (match) document.getElementById('username').textContent = match[1];
});

// Fun√ß√£o para mostrar o bot√£o Dashboard se for admin
fetch('/ai/role').then(r => r.text()).then(role => {
    if (role.trim().toLowerCase() === 'admin') {
        document.getElementById('dashboard-btn').innerHTML = '<a href="/admin/dashboard" class="dashboard-link">Dashboard</a>';
        document.getElementById('dashboard-btn').style.display = 'block';
    }
});

// Carrega status dos LLMs e prefer√™ncias do user e gera checkboxes
let lastPrefs = {};
async function loadLLMStatusAndPrefs() {
    let status = {};
    let prefs = {};
    try {
        const statusResp = await fetch('/admin/llm-status');
        if (!statusResp.ok) {
            document.getElementById('llm-checkbox-list').innerHTML = '<span style="color:red">Erro ao carregar prefer√™ncias de LLM.</span>';
            document.getElementById('llm-status-info').innerHTML = '';
            document.getElementById('save-prefs-btn').disabled = true;
            return;
        }
        status = await statusResp.json();
        const prefsResp = await fetch('/admin/llm-user-prefs');
        if (prefsResp.ok) {
            prefs = await prefsResp.json();
        }
    } catch {
        document.getElementById('llm-checkbox-list').innerHTML = '<span style="color:red">Erro ao carregar prefer√™ncias de LLM.</span>';
        document.getElementById('llm-status-info').innerHTML = '';
        document.getElementById('save-prefs-btn').disabled = true;
        return;
    }
    lastPrefs = { ...prefs };
    // Gera checkboxes
    const list = document.getElementById('llm-checkbox-list');
    list.innerHTML = '';
    Object.keys(status).forEach(llm => {
        const checked = !!prefs[llm];
        const disabled = !status[llm];
        const label = document.createElement('label');
        label.className = 'llm-checkbox-label' + (disabled ? ' llm-disabled' : '');
        label.innerHTML = `<input type="checkbox" name="llm-${llm}" value="${llm}" ${checked ? 'checked' : ''} ${disabled ? 'disabled' : ''}> ${llm.charAt(0).toUpperCase() + llm.slice(1)}`;
        list.appendChild(label);
    });
    // Mostra info
    document.getElementById('llm-status-info').innerHTML =
        Object.entries(status).map(([llm, v]) => `<span class=\"llm-status ${v ? 'active' : 'inactive'}\">${llm.charAt(0).toUpperCase() + llm.slice(1)}: ${v ? 'Ativo' : 'Em baixo'}</span>`).join('<br>');
    document.getElementById('save-prefs-btn').disabled = true;
}
loadLLMStatusAndPrefs();

// Ativa bot√£o se houver altera√ß√µes
const llmForm = document.getElementById('llm-preferences-form');
llmForm.addEventListener('change', function() {
    const checkboxes = llmForm.querySelectorAll('input[type=checkbox]');
    let changed = false;
    checkboxes.forEach(cb => {
        if (lastPrefs[cb.value] !== cb.checked) changed = true;
    });
    document.getElementById('save-prefs-btn').disabled = !changed;
});

// Guardar prefer√™ncias
llmForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const checkboxes = llmForm.querySelectorAll('input[type=checkbox]');
    const prefs = {};
    checkboxes.forEach(cb => {
        prefs[cb.value] = cb.checked;
    });
    const btn = document.getElementById('save-prefs-btn');
    btn.disabled = true;
    const feedback = document.getElementById('llm-prefs-feedback');
    feedback.textContent = 'A guardar...';
    feedback.className = 'feedback-message';
    try {
        await fetch('/admin/llm-user-prefs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(prefs)
        });
        feedback.textContent = 'Prefer√™ncias guardadas com sucesso!';
        feedback.className = 'feedback-message success';
        lastPrefs = { ...prefs };
        setTimeout(() => {
            feedback.textContent = '';
            feedback.className = 'feedback-message';
        }, 2000);
    } catch {
        feedback.textContent = 'Erro ao guardar prefer√™ncias.';
        feedback.className = 'feedback-message error';
    }
});

// Mostrar aba do ficheiro carregado junto ao input
const fileInput = document.getElementById('file-upload');
const fileChip = document.getElementById('file-chip');
fileInput.addEventListener('change', function() {
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileChip.innerHTML = `<span class='file-chip-icon'>üìé</span> <span class='file-chip-name'>${file.name}</span> <span class='file-chip-remove' title='Remover'>&times;</span>`;
        fileChip.style.display = 'flex';
    } else {
        fileChip.style.display = 'none';
    }
});
fileChip.addEventListener('click', function(e) {
    if (e.target.classList.contains('file-chip-remove')) {
        fileInput.value = '';
        fileChip.style.display = 'none';
    }
});

// Fun√ß√£o para mostrar mensagem de boas-vindas
function showWelcomeMessage() {
    let welcomeMessage = document.getElementById('welcome-message');
    
    // Se o elemento n√£o existe, recri√°-lo
    if (!welcomeMessage) {
        welcomeMessage = document.createElement('div');
        welcomeMessage.id = 'welcome-message';
        welcomeMessage.className = 'welcome-message';
        welcomeMessage.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; padding: 40px 20px;';
        welcomeMessage.innerHTML = `
            <div class="welcome-content" style="text-align: center; max-width: 500px; background: #fff; border-radius: 20px; padding: 40px 30px; box-shadow: 0 4px 20px rgba(24, 60, 124, 0.1); border: 1px solid rgba(24, 60, 124, 0.1);">
                <h2 style="color: #183c7c; margin: 0 0 15px 0; font-size: 1.8rem; font-weight: 600;">Bem-vindo ao PromptShield</h2>
                <p style="color: #64748b; margin: 0 0 20px 0; font-size: 1.1rem; line-height: 1.6;">Comece uma nova conversa para come√ßar a usar a IA de forma segura.</p>
                <div class="welcome-tips" style="background: rgba(24, 60, 124, 0.05); border-radius: 12px; padding: 15px; border-left: 4px solid #183c7c;">
                    <p style="margin: 0; font-size: 0.95rem; color: #475569;"><strong>Dica:</strong> Pode anexar ficheiros para an√°lise ou fazer perguntas diretas.</p>
                </div>
            </div>
        `;
        chatMessages.appendChild(welcomeMessage);
    }
    
    welcomeMessage.style.display = 'flex';
}

// Fun√ß√£o para esconder mensagem de boas-vindas
function hideWelcomeMessage() {
    const welcomeMessage = document.getElementById('welcome-message');
    if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
    }
}

// === MULTICHAT UI MODERNA ===
let currentChatId = null;
const sidebarChats = document.getElementById('sidebar-chats');
const chatMessages = document.getElementById('chat-messages');

async function loadChats() {
    const chats = await fetch('/api/chat').then(r => r.json());
    sidebarChats.innerHTML = '';
    
    // Se n√£o h√° chats, mostrar mensagem de estado vazio
    if (chats.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'empty-chats-message';
        emptyMessage.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 200px; padding: 20px; background: #fff; border-radius: 12px; margin: 10px; border: 1px solid rgba(24, 60, 124, 0.1);';
        emptyMessage.innerHTML = `
            <div class="empty-chats-content" style="text-align: center; color: #64748b;">
                <p style="margin: 0 0 8px 0; font-size: 1rem; font-weight: 500; color: #475569;">Nenhum chat ainda</p>
                <small style="font-size: 0.85rem; opacity: 0.8; color: #94a3b8;">Clique em + para come√ßar</small>
            </div>
        `;
        sidebarChats.appendChild(emptyMessage);
        return;
    }
    
    chats.forEach((chat, idx) => {
        const div = document.createElement('div');
        div.className = 'chat-list-item' + (currentChatId===chat.id?' selected':'');
        
        // Mostrar nome do chat ou "Novo chat" se estiver vazio
        const chatName = chat.name && chat.name.trim() !== '' ? chat.name : 'Novo chat';
        div.textContent = chatName;
        
        div.onclick = () => selectChat(chat.id);
        // Bot√£o deletar (SVG minimalista)
        const del = document.createElement('button');
        del.className = 'delete-chat-btn';
        del.title = 'Apagar chat';
        del.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
        del.onclick = (e) => { e.stopPropagation(); deleteChat(chat.id); };
        div.appendChild(del);
        sidebarChats.appendChild(div);
    });
}
async function selectChat(chatId) {
    currentChatId = chatId;
    await loadChats();
    // Limpa mensagens
    chatMessages.innerHTML = '';
    // Carrega hist√≥rico
    const hist = await fetch(`/api/chat/${chatId}/questions`).then(r=>r.json());
    
    // Se h√° hist√≥rico, esconder mensagem de boas-vindas
    if (hist.length > 0) {
        hideWelcomeMessage();
    } else {
        // Se n√£o h√° hist√≥rico, mostrar mensagem de boas-vindas
        showWelcomeMessage();
    }
    
    hist.forEach(q => {
        // Para o hist√≥rico, n√£o temos informa√ß√£o sobre ficheiros anexados
        // mas podemos detectar se a pergunta cont√©m conte√∫do de ficheiro
        let attachedFileName = null;
        let displayQuestion = q.question;
        
        if (q.question && q.question.includes('--- Conte√∫do de')) {
            // Extrai o nome do ficheiro da pergunta
            const match = q.question.match(/--- Conte√∫do de (.+?) ---/);
            if (match) {
                attachedFileName = match[1];
                // Remove o conte√∫do do ficheiro da pergunta exibida
                const questionMatch = q.question.match(/Pergunta:\s*(.+)$/);
                if (questionMatch) {
                    displayQuestion = questionMatch[1].trim();
                } else {
                    displayQuestion = "Pergunta sobre ficheiro anexado";
                }
            }
        }
        
        addMessage('Voc√™', displayQuestion, 'user', false, attachedFileName);
        addMessage(
            q.model ? (q.model.charAt(0).toUpperCase() + q.model.slice(1)) : 'LLM',
            q.answer, 'llm-' + (q.model ? q.model.toLowerCase() : 'llm')
        );
    });
    // Scroll para baixo ap√≥s carregar hist√≥rico
    setTimeout(scrollToBottom, 100);
}
async function deleteChat(chatId) {
    try {
        const response = await fetch(`/api/chat/${chatId}`, {method:'DELETE'});
        if (response.ok) {
            const responseData = await response.json();
            if(currentChatId===chatId) currentChatId=null;
            await loadChats();
            
            // Limpar mensagens e mostrar boas-vindas
            chatMessages.innerHTML = '';
            
            // Aguardar um pouco antes de mostrar a mensagem de boas-vindas
            setTimeout(() => {
                showWelcomeMessage();
            }, 100);
            
            // Mostrar mensagem de sucesso
            if (responseData.message) {
                // Criar uma notifica√ß√£o tempor√°ria
                const notification = document.createElement('div');
                notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:12px 20px;border-radius:8px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
                notification.textContent = responseData.message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        } else {
            const errorData = await response.json();
            alert('Erro ao apagar chat: ' + (errorData.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao apagar chat:', error);
        alert('Erro ao apagar chat. Tente novamente.');
    }
}
document.getElementById('new-chat-btn').addEventListener('click', async function() {
    // Cria chat vazio (sem nome)
    const chat = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name: ''})
    }).then(r=>r.json());
    currentChatId = chat.id;
    await loadChats();
    selectChat(chat.id);
    // Limpa mensagens e mostra mensagem de boas-vindas
    chatMessages.innerHTML = '';
    showWelcomeMessage();
    document.getElementById('question').focus();
});
// Carrega chats ao iniciar
loadChats();

// Garantir que o input fica sempre vis√≠vel quando clicado
document.getElementById('question').addEventListener('focus', function() {
    setTimeout(scrollToBottom, 100);
});

// Scroll para baixo quando a p√°gina carrega
window.addEventListener('load', function() {
    setTimeout(scrollToBottom, 200);
});

// L√≥gica de envio de mensagem e upload de ficheiros
const chatForm = document.getElementById('chat-form');

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    let question = document.getElementById('question').value;
    if (!question.trim()) return;

    // Se n√£o houver chat selecionado, cria um novo com o nome igual √† primeira frase
    if (!currentChatId) {
        let firstSentence = question.split(/[.!?]/)[0];
        if (firstSentence.length > 30) firstSentence = firstSentence.slice(0, 30) + '...';
        const chat = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: firstSentence })
        }).then(r => r.json());
        currentChatId = chat.id;
        await loadChats();
    } else {
        // Se o chat selecionado n√£o tem nome (chat vazio), atualiza o nome na primeira mensagem
        const selectedChat = Array.from(document.querySelectorAll('.chat-list-item')).find(div => div.classList.contains('selected'));
        if (selectedChat && (selectedChat.textContent.trim() === '' || selectedChat.textContent.trim() === 'Chat ' + currentChatId || selectedChat.textContent.trim() === 'Novo chat')) {
            let firstSentence = question.split(/[.!?]/)[0];
            if (firstSentence.length > 30) firstSentence = firstSentence.slice(0, 30) + '...';
            try {
                const updateResponse = await fetch(`/api/chat/${currentChatId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: firstSentence })
                });
                if (updateResponse.ok) {
                    await loadChats();
                }
            } catch (error) {
                console.error('Erro ao atualizar nome do chat:', error);
            }
        }
    }

    let fileIds = [];
    if (fileInput.files.length > 0) {
        const formData = new FormData();
        for (const file of fileInput.files) {
            formData.append('files', file);
        }
        const uploadResp = await fetch('/files/upload', { method: 'POST', body: formData });
        if (uploadResp.ok) {
            fileIds = await uploadResp.json();
        } else {
            alert('Erro ao fazer upload dos ficheiros.');
            return;
        }
    }
    // Guarda o nome do ficheiro antes de limpar o input
    let attachedFileName = null;
    if (fileInput.files.length > 0) {
        attachedFileName = fileInput.files[0].name;
    }
    
    fileInput.value = '';
    fileChip.style.display = 'none';
    document.getElementById('question').value = '';
    
    const resp = await fetch('/ai/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, fileIds, chatId: currentChatId })
    });
    if (resp.ok) {
        const data = await resp.json();
        
        if (data.maskedQuestion) {
            // Mostra apenas a pergunta original, n√£o o conte√∫do dos ficheiros
            addMessage('Voc√™', data.maskedQuestion, 'user', false, attachedFileName);
        }
        if (data.llmAnswers && Array.isArray(data.llmAnswers)) {
            data.llmAnswers.forEach(ans => {
                addLLMAnswers(ans);
            });
        }
    } else {
        addMessage('Erro', 'Falha ao obter resposta do chatbot.', 'error');
    }
});

function addLLMAnswers(answerText) {
    // Verifica se a resposta come√ßa com um identificador de modelo
    const modelMatch = answerText.match(/^(OpenAI|Ollama):\s*(.*)/i);
    
    if (modelMatch) {
        const model = modelMatch[1];
        const content = modelMatch[2];
        
        // Se h√° mais conte√∫do ap√≥s o identificador, inclui tudo
        const fullContent = answerText.substring(answerText.indexOf(':') + 1).trim();
        
        // Processa quebras de linha mantendo a formata√ß√£o
        const processedContent = fullContent
            .replace(/\n\n/g, '<br><br>') // Duplas quebras de linha
            .replace(/\n/g, '<br>'); // Quebras de linha simples
        
        addMessage(model, processedContent, 'llm-' + model.toLowerCase(), true);
    } else {
        // Se n√£o h√° identificador de modelo, trata como resposta gen√©rica
        const processedContent = answerText
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
        
        addMessage('LLM', processedContent, 'llm-llm', true);
    }
}

function addMessage(author, text, type, typingEffect = false, attachedFile = null) {
    // Esconder mensagem de boas-vindas quando a primeira mensagem √© adicionada
    hideWelcomeMessage();
    
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-message ' + type;
    
    // Se h√° ficheiro anexado, adiciona o chip do ficheiro
    let fileChipHTML = '';
    if (attachedFile) {
        fileChipHTML = `
            <div class="message-file-chip">
                <span class="file-chip-icon">üìé</span>
                <span class="file-chip-name">${attachedFile}</span>
            </div>
        `;
    }
    
    msgDiv.innerHTML = `
        <strong>${author}:</strong>
        ${fileChipHTML}
        <span class="message-content"></span>
    `;
    chatMessages.appendChild(msgDiv);
    
    // Scroll para baixo imediatamente
    scrollToBottom();
    
    const span = msgDiv.querySelector('.message-content');
    
    // Processa o texto para quebras de linha adequadas
    const processedText = text
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>');
    
    if (typingEffect) {
        // Para efeito de digita√ß√£o com HTML, vamos processar de forma diferente
        const textWithoutHTML = text.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
        let i = 0;
        let currentHTML = '';
        
        function typeChar() {
            if (i <= textWithoutHTML.length) {
                // Reconstr√≥i o HTML progressivamente
                const currentText = textWithoutHTML.slice(0, i);
                currentHTML = currentText.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
                span.innerHTML = currentHTML;
                scrollToBottom();
                i++;
                setTimeout(typeChar, 8); // velocidade do efeito
            } else {
                // Garante que o HTML final est√° correto
                span.innerHTML = processedText;
                scrollToBottom();
            }
        }
        typeChar();
    } else {
        span.innerHTML = processedText;
        scrollToBottom();
    }
}

// Fun√ß√£o para scroll suave para baixo
function scrollToBottom() {
    chatMessages.scrollTo({
        top: chatMessages.scrollHeight,
        behavior: 'smooth'
    });
}
// Prefer√™ncias de LLM em modal
const llmPrefsModal = document.getElementById('llm-prefs-modal');
document.getElementById('settings-btn').onclick = () => {
    llmPrefsModal.style.display = 'flex';
};
document.getElementById('close-prefs-btn').onclick = () => {
    llmPrefsModal.style.display = 'none';
};
</script>
</body>
</html> 