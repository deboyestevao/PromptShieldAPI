<!doctype html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/adminDashboard.css" rel="stylesheet" type="text/css">
    <link href="/css/adminReports.css" rel="stylesheet" type="text/css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <title>Gestão de Reports - PromptShield</title>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <span class="logo-text">PromptShield</span>
                <span class="admin-badge">Admin</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-title">Dashboard</h3>
                <a href="/admin/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Visão Geral</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Gestão</h3>
                <a href="/admin/users" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Utilizadores</span>
                </a>
                <a href="/admin/reports" class="nav-item active">
                    <i class="fas fa-flag"></i>
                    <span>Reports</span>
                </a>
                <a href="/admin/system-preferences" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
                <a href="/admin/config-history" class="nav-item">
                    <i class="fas fa-history"></i>
                    <span>Histórico</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Sistema</h3>
                <a href="/chat" class="nav-item">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <div class="breadcrumb">
                    <span>Dashboard</span>
                    <i class="fas fa-chevron-right"></i>
                    <span>Reports</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="notification-container">
                    <button class="notification-bell" id="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-count">0</span>
                    </button>
                    
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notificações</h3>
                            <button id="mark-all-read" class="mark-all-read-btn">
                                <i class="fas fa-check-double"></i>
                                Marcar todas
                            </button>
                        </div>
                        <div class="notification-list" id="notification-list">
                            <!-- Notificações serão carregadas aqui -->
                        </div>
                        <div class="notification-empty" id="notification-empty" style="display:none;">
                            <i class="fas fa-bell-slash"></i>
                            <p>Nenhuma notificação</p>
                        </div>
                    </div>
                </div>
                
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <span class="user-name">Administrador</span>
                        <span class="user-role">Admin</span>
                    </div>
                    <a href="/auth/logout" class="logout-link" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- Reports Content -->
        <div class="dashboard-container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div class="welcome-content">
                    <h1>Gestão de Reports</h1>
                    <p>Analise e gerencie solicitações de reativação de contas desativadas</p>
                </div>
            </section>

            <!-- Statistics Section -->
            <section class="metrics-section">
                <div class="metrics-grid">
                    <div class="metric-card" data-metric="total">
                        <div class="metric-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value" id="total-reports">0</div>
                            <div class="metric-label">Total de Reports</div>
                        </div>
                    </div>

                    <div class="metric-card" data-metric="pending">
                        <div class="metric-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value" id="pending-reports">0</div>
                            <div class="metric-label">Reports Pendentes</div>
                        </div>
                    </div>

                    <div class="metric-card" data-metric="resolved">
                        <div class="metric-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value" id="resolved-reports">0</div>
                            <div class="metric-label">Reports Resolvidos</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Filters Section -->
            <section class="quick-actions-section">
                <div class="section-header">
                    <h2>Filtros e Controles</h2>
                    <p>Filtre e organize os reports conforme necessário</p>
                </div>
                
                <div class="reports-controls">
                    <div class="filter-controls">
                        <select id="status-filter" class="filter-select">
                            <option value="">Todos os estados</option>
                            <option value="PENDING">Pendentes</option>
                            <option value="APPROVED">Aprovados</option>
                            <option value="REJECTED">Rejeitados</option>
                        </select>
                        <select id="sort-filter" class="filter-select">
                            <option value="date-desc">Mais recentes</option>
                            <option value="date-asc">Mais antigos</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Reports List Section -->
            <section class="activity-section">
                <div class="activity-panel">
                    <div class="panel-header">
                        <h3>Lista de Reports</h3>
                        <button class="refresh-btn" id="refresh-reports">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div class="reports-container" id="reports-container">
                        <!-- Os reports serão carregados aqui via JavaScript -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        let allReports = [];
        let filteredReports = [];

        // Carregar reports quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            loadReports();
            setupEventListeners();
            loadNotifications();
        });

        function setupEventListeners() {
            document.getElementById('status-filter').addEventListener('change', filterReports);
            document.getElementById('sort-filter').addEventListener('change', filterReports);
            
            // Refresh button
            const refreshBtn = document.getElementById('refresh-reports');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    this.classList.add('rotating');
                    setTimeout(() => {
                        this.classList.remove('rotating');
                    }, 1000);
                    loadReports();
                });
            }
            
            // Notification bell
            const notificationBell = document.getElementById('notification-bell');
            if (notificationBell) {
                notificationBell.addEventListener('click', function() {
                    const dropdown = document.getElementById('notification-dropdown');
                    dropdown.classList.toggle('active');
                });
            }
            
            // Mark all as read
            const markAllReadBtn = document.getElementById('mark-all-read');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', function() {
                    markAllNotificationsAsRead();
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const bell = document.getElementById('notification-bell');
                const dropdown = document.getElementById('notification-dropdown');
                if (bell && dropdown && !bell.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }

        async function loadReports() {
            try {
                const response = await fetch('/admin/api/reports');
                if (response.ok) {
                    const data = await response.json();
                    allReports = data;
                    filteredReports = [...allReports];
                    updateStats();
                    renderReports();
                } else {
                    showNotification('Erro ao carregar reports', 'error');
                }
            } catch (error) {
                showNotification('Erro de conexão', 'error');
            }
        }

        function updateStats() {
            const total = allReports.length;
            const pending = allReports.filter(r => r.status === 'PENDING').length;
            const resolved = allReports.filter(r => r.status !== 'PENDING').length;

            document.getElementById('total-reports').textContent = total;
            document.getElementById('pending-reports').textContent = pending;
            document.getElementById('resolved-reports').textContent = resolved;
        }

        function filterReports() {
            const statusFilter = document.getElementById('status-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;

            filteredReports = allReports.filter(report => {
                const matchesStatus = !statusFilter || report.status === statusFilter;
                return matchesStatus;
            });

            // Ordenar
            filteredReports.sort((a, b) => {
                switch (sortFilter) {
                    case 'date-desc':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'date-asc':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    default:
                        return 0;
                }
            });

            renderReports();
        }

        function renderReports() {
            const container = document.getElementById('reports-container');

            if (filteredReports.length === 0) {
                container.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Nenhum report encontrado</div>
                            <div class="activity-detail">Não há reports para mostrar com os filtros atuais</div>
                            <div class="activity-time">Agora</div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredReports.map(report => `
                <div class="activity-item report-item ${report.status.toLowerCase()}">
                    <div class="activity-icon">
                        <i class="${getReportIcon(report.status)}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">
                            ${report.userName} - ${report.userEmail}
                            <span class="status-badge ${report.status.toLowerCase()}">${report.statusDisplay}</span>
                        </div>
                        <div class="activity-detail">${report.reason}</div>
                        <div class="activity-time">
                            Solicitado: ${formatTime(report.createdAt)}
                            ${report.resolvedAt ? ` • Resolvido: ${formatTime(report.resolvedAt)}` : ''}
                            ${report.resolvedBy ? ` • Por: ${report.resolvedBy}` : ''}
                        </div>
                        ${report.status === 'PENDING' ? `
                            <div class="report-actions">
                                <button class="btn btn-success" onclick="approveReport(${report.id})">
                                    <i class="fas fa-check"></i>
                                    Aprovar
                                </button>
                                <button class="btn btn-danger" onclick="rejectReport(${report.id})">
                                    <i class="fas fa-times"></i>
                                    Rejeitar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getReportIcon(status) {
            const icons = {
                'PENDING': 'fas fa-clock',
                'APPROVED': 'fas fa-check-circle',
                'REJECTED': 'fas fa-times-circle'
            };
            return icons[status] || 'fas fa-file-alt';
        }

        async function approveReport(reportId) {
            if (confirm('Tem a certeza que deseja aprovar este report e ativar o utilizador?')) {
                try {
                    const response = await fetch(`/admin/api/reports/${reportId}/approve`, { method: 'POST' });
                    if (response.ok) {
                        showNotification('Report aprovado com sucesso', 'success');
                        loadReports();
                    } else {
                        showNotification('Erro ao aprovar report', 'error');
                    }
                } catch (error) {
                    showNotification('Erro de conexão', 'error');
                }
            }
        }

        async function rejectReport(reportId) {
            if (confirm('Tem a certeza que deseja rejeitar este report?')) {
                try {
                    const response = await fetch(`/admin/api/reports/${reportId}/reject`, { method: 'POST' });
                    if (response.ok) {
                        showNotification('Report rejeitado com sucesso', 'success');
                        loadReports();
                    } else {
                        showNotification('Erro ao rejeitar report', 'error');
                    }
                } catch (error) {
                    showNotification('Erro de conexão', 'error');
                }
            }
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Agora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m atrás`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h atrás`;
            return date.toLocaleDateString('pt-PT');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Notification functions
        function loadNotifications() {
            fetch('/admin/api/notifications/count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('notification-count').textContent = data.unreadCount;
                })
                .catch(error => {
                    document.getElementById('notification-count').textContent = '0';
                });
            
            fetch('/admin/api/notifications')
                .then(response => response.json())
                .then(notifications => {
                    const list = document.getElementById('notification-list');
                    const empty = document.getElementById('notification-empty');
                    
                    if (notifications.length === 0) {
                        list.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    list.style.display = 'block';
                    empty.style.display = 'none';
                    
                    list.innerHTML = notifications.map(notification => `
                        <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                            <div class="notification-icon">
                                <i class="${getNotificationIcon(notification.type)}"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${formatTime(notification.createdAt)}</div>
                            </div>
                            ${!notification.read ? '<div class="notification-dot"></div>' : ''}
                        </div>
                    `).join('');
                    
                    document.querySelectorAll('.notification-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const notificationId = this.dataset.id;
                            markNotificationAsRead(notificationId);
                            this.classList.remove('unread');
                            this.classList.add('read');
                            this.querySelector('.notification-dot')?.remove();
                        });
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar notificações:', error);
                });
        }
        
        function markNotificationAsRead(notificationId) {
            fetch(`/admin/api/notifications/${notificationId}/read`, {
                method: 'POST'
            }).then(() => {
                loadNotifications();
            }).catch(error => {
                console.error('Erro ao marcar notificação como lida:', error);
            });
        }
        
        function markAllNotificationsAsRead() {
            fetch('/admin/api/notifications/read-all', {
                method: 'POST'
            }).then(() => {
                loadNotifications();
            }).catch(error => {
                console.error('Erro ao marcar todas como lidas:', error);
            });
        }
        
        function getNotificationIcon(type) {
            const icons = {
                'REPORT': 'fas fa-flag',
                'SYSTEM': 'fas fa-cog',
                'USER': 'fas fa-user',
                'ALERT': 'fas fa-exclamation-triangle',
                'STATS': 'fas fa-chart-bar'
            };
            return icons[type] || icons['SYSTEM'];
        }
    </script>
</body>
</html> 