<!doctype html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/adminDashboard.css" rel="stylesheet" type="text/css">
    <title>Administração - PromptShield</title>
</head>
<body>
    <header class="admin-header">
        <div class="admin-logo">
            <a href="/chat">PromptShield</a>
            <span class="admin-badge">Admin</span>
        </div>
        <div class="admin-user-info">
            <div class="notification-bell" id="notification-bell">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span class="notification-badge" id="notification-count">0</span>
            </div>
            
            <!-- Dropdown de notificações -->
            <div class="notification-dropdown" id="notification-dropdown">
                <div class="notification-header">
                    <h3>Notificações</h3>
                    <button id="mark-all-read" class="mark-all-read-btn">Marcar todas como lidas</button>
                </div>
                <div class="notification-list" id="notification-list">
                    <!-- Notificações serão carregadas aqui -->
                </div>
                <div class="notification-empty" id="notification-empty" style="display:none;">
                    <p>Nenhuma notificação</p>
                </div>
            </div>
            <span class="admin-avatar">A</span>
        </div>
    </header>
    <main class="admin-main">
        <div class="dashboard-header">
            <div class="header-content">
                <h1>Dashboard de Administração</h1>
                <p class="dashboard-subtitle">Bem-vindo ao painel de controlo do PromptShield</p>
            </div>
            <div class="quick-stats">
                <div class="stat-item">
                    <div class="stat-icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="total-users">-</span>
                        <span class="stat-label">Utilizadores</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="pending-reports">-</span>
                        <span class="stat-label">Reports Pendentes</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="active-sessions">-</span>
                        <span class="stat-label">Sessões Ativas</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="section-header">
                <h2>Gestão do Sistema</h2>
                <p>Ferramentas essenciais para administrar a plataforma</p>
            </div>
            <div class="admin-cards-grid">
            <div class="admin-card">
                <div class="admin-card-icon admin-card-icon-sys">
                    <svg width="38" height="38" fill="none" stroke="#183c7c" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="4"/><path d="M7 7h.01M7 11h10M7 15h6"/></svg>
                </div>
                <h2>Configurações do Sistema</h2>
                <p>Altere preferências globais, ative/desative LLMs e ajuste parâmetros do sistema.</p>
                <a href="/admin/system-preferences" class="admin-btn-link">Configurar Sistema <span class="admin-btn-arrow">→</span></a>
            </div>
            <div class="admin-card">
                <div class="admin-card-icon admin-card-icon-users">
                    <svg width="38" height="38" fill="none" stroke="#183c7c" stroke-width="2" viewBox="0 0 24 24"><circle cx="9" cy="7" r="4"/><path d="M17 11a4 4 0 1 0-8 0v1a4 4 0 0 0 8 0v-1z"/><path d="M17 21v-2a4 4 0 0 0-8 0v2"/></svg>
                </div>
                <h2>Gestão de Utilizadores</h2>
                <p>Veja, edite ou remova utilizadores registados na plataforma.</p>
                <a href="/admin/users" class="admin-btn-link">Gerir Utilizadores <span class="admin-btn-arrow">→</span></a>
            </div>
            <div class="admin-card">
                <div class="admin-card-icon admin-card-icon-reports">
                    <svg width="38" height="38" fill="none" stroke="#183c7c" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>
                </div>
                <h2>Gestão de Reports</h2>
                <p>Analisar e responder a solicitações de reativação de contas desativadas.</p>
                <a href="/admin/reports" class="admin-btn-link">Gerir Reports <span class="admin-btn-arrow">→</span></a>
            </div>
            <div class="admin-card">
                <div class="admin-card-icon admin-card-icon-history">
                    <svg width="38" height="38" fill="none" stroke="#183c7c" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h2>Histórico de Configurações</h2>
                <p>Visualizar histórico completo de alterações nos modelos LLM e configurações do sistema.</p>
                <a href="/admin/config-history" class="admin-btn-link">Ver Histórico <span class="admin-btn-arrow">→</span></a>
            </div>
        </div>

        <div class="quick-actions">
            <div class="section-header">
                <h2>Ações Rápidas</h2>
                <p>Acesso direto às funcionalidades mais utilizadas</p>
            </div>
            <div class="actions-grid">
                <a href="/admin/users" class="action-card">
                    <div class="action-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                    </div>
                    <span>Ver Utilizadores</span>
                </a>
                <a href="/admin/reports" class="action-card">
                    <div class="action-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <span>Verificar Reports</span>
                </a>
                <a href="/admin/system-preferences" class="action-card">
                    <div class="action-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <span>Configurações</span>
                </a>
                <a href="/admin/config-history" class="action-card">
                    <div class="action-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <span>Histórico</span>
                </a>
                <a href="/chat" class="action-card">
                    <div class="action-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <span>Ir para Chat</span>
                </a>
            </div>
        </div>

        <div class="dashboard-footer">
            <div class="recent-activity">
                <h3>Atividade Recente</h3>
                <div class="activity-list" id="activity-list">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12,6 12,12 16,14"></polyline>
                            </svg>
                        </div>
                        <div class="activity-content">
                            <span class="activity-text">Sistema iniciado com sucesso</span>
                            <span class="activity-time">Agora</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="system-status">
                <h3>Estado do Sistema</h3>
                <div class="status-grid">
                    <div class="status-item online">
                        <div class="status-indicator"></div>
                        <span>Servidor Online</span>
                    </div>
                    <div class="status-item online">
                        <div class="status-indicator"></div>
                        <span>Base de Dados</span>
                    </div>
                    <div class="status-item online">
                        <div class="status-indicator"></div>
                        <span>API Funcional</span>
                    </div>
                </div>
                

            </div>
        </div>
    </main>

    <script>
        // Carregar estatísticas quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            carregarEstatisticas();
        });

        // Função simples para carregar estatísticas
        function carregarEstatisticas() {
            // Carregar número de utilizadores
            fetch('/admin/api/users')
                .then(response => response.json())
                .then(users => {
                    document.getElementById('total-users').textContent = users.length;
                })
                .catch(error => {
                    document.getElementById('total-users').textContent = '0';
                });

            // Carregar número de reports pendentes
            fetch('/admin/api/reports')
                .then(response => response.json())
                .then(reports => {
                    const pendentes = reports.filter(r => r.status === 'PENDING').length;
                    document.getElementById('pending-reports').textContent = pendentes;
                })
                .catch(error => {
                    document.getElementById('pending-reports').textContent = '0';
                });

            // Simular sessões ativas (valor fixo por simplicidade)
            document.getElementById('active-sessions').textContent = '2';
            
            // Carregar notificações
            loadNotifications();
        }
        
        // Event listeners para notificações
        document.addEventListener('DOMContentLoaded', function() {
            // Event listener para o sino de notificações
            const notificationBell = document.getElementById('notification-bell');
            if (notificationBell) {
                notificationBell.addEventListener('click', function() {
                    const dropdown = document.getElementById('notification-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                });
            }
            
            // Event listener para marcar todas como lidas
            const markAllReadBtn = document.getElementById('mark-all-read');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', function() {
                    markAllNotificationsAsRead();
                });
            }
            
            // Fechar dropdown quando clicar fora
            document.addEventListener('click', function(event) {
                const bell = document.getElementById('notification-bell');
                const dropdown = document.getElementById('notification-dropdown');
                if (bell && dropdown && !bell.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });
        });

        // Função para carregar notificações
        function loadNotifications() {
            // Carregar contador
            fetch('/admin/api/notifications/count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('notification-count').textContent = data.unreadCount;
                })
                .catch(error => {
                    document.getElementById('notification-count').textContent = '0';
                });
            
            // Carregar lista de notificações
            fetch('/admin/api/notifications')
                .then(response => response.json())
                .then(notifications => {
                    const list = document.getElementById('notification-list');
                    const empty = document.getElementById('notification-empty');
                    
                    if (notifications.length === 0) {
                        list.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    list.style.display = 'block';
                    empty.style.display = 'none';
                    
                    list.innerHTML = notifications.map(notification => `
                        <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                            <div class="notification-icon">
                                ${getNotificationIcon(notification.type)}
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${formatTime(notification.createdAt)}</div>
                            </div>
                            ${!notification.read ? '<div class="notification-dot"></div>' : ''}
                        </div>
                    `).join('');
                    
                    // Adicionar event listeners para cada notificação
                    document.querySelectorAll('.notification-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const notificationId = this.dataset.id;
                            markNotificationAsRead(notificationId);
                            this.classList.remove('unread');
                            this.classList.add('read');
                            this.querySelector('.notification-dot')?.remove();
                        });
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar notificações:', error);
                });
        }
        
        // Função para marcar notificação como lida
        function markNotificationAsRead(notificationId) {
            fetch(`/admin/api/notifications/${notificationId}/read`, {
                method: 'POST'
            }).then(() => {
                loadNotifications();
            }).catch(error => {
                console.error('Erro ao marcar notificação como lida:', error);
            });
        }
        
        // Função para marcar todas como lidas
        function markAllNotificationsAsRead() {
            fetch('/admin/api/notifications/read-all', {
                method: 'POST'
            }).then(() => {
                loadNotifications();
            }).catch(error => {
                console.error('Erro ao marcar todas como lidas:', error);
            });
        }
        
        // Função para obter ícone SVG baseado no tipo de notificação
        function getNotificationIcon(type) {
            const icons = {
                'REPORT': `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                </svg>`,
                'SYSTEM': `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>`,
                'USER': `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>`,
                'ALERT': `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>`,
                'STATS': `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M18 20V10"></path>
                    <path d="M12 20V4"></path>
                    <path d="M6 20v-6"></path>
                </svg>`
            };
            return icons[type] || icons['SYSTEM'];
        }
        
        // Função para formatar tempo
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Agora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m atrás`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h atrás`;
            return date.toLocaleDateString('pt-PT');
        }
    </script>
</body>
</html> 