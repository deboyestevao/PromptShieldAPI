<!doctype html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/adminDashboard.css" rel="stylesheet" type="text/css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <title>Administração - PromptShield</title>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <span class="logo-text">PromptShield</span>
                <span class="admin-badge">Admin</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-title">Dashboard</h3>
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Visão Geral</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Gestão</h3>
                <a href="/admin/users" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Utilizadores</span>
                </a>
                <a href="/admin/reports" class="nav-item">
                    <i class="fas fa-flag"></i>
                    <span>Reports</span>
                </a>
                <a href="/admin/system-preferences" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
                <a href="/admin/config-history" class="nav-item">
                    <i class="fas fa-history"></i>
                    <span>Histórico</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Sistema</h3>
                <a href="/chat" class="nav-item">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <div class="breadcrumb">
                    <span>Dashboard</span>
                    <i class="fas fa-chevron-right"></i>
                    <span>Visão Geral</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="notification-container">
                    
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notificações</h3>
                            <button id="mark-all-read" class="mark-all-read-btn">
                                <i class="fas fa-check-double"></i>
                                Marcar todas
                            </button>
                        </div>
                        <div class="notification-list" id="notification-list">
                            <!-- Notificações serão carregadas aqui -->
                        </div>
                        <div class="notification-empty" id="notification-empty" style="display:none;">
                            <i class="fas fa-bell-slash"></i>
                            <p>Nenhuma notificação</p>
                        </div>
                    </div>
                </div>
                
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <span class="user-name">Administrador</span>
                        <span class="user-role">Admin</span>
                    </div>
                    <a href="/auth/logout" class="logout-link" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div class="welcome-content">
                    <h1>Dashboard</h1>
                    <p>Gerencie a plataforma PromptShield com ferramentas poderosas e insights em tempo real</p>
                </div>
            </section>

            <!-- Real-time Metrics -->
            <section class="metrics-section">
                <div class="metrics-grid">

                    <div class="metric-card" data-metric="reports">
                        <div class="metric-icon">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value" id="pending-reports">-</div>
                            <div class="metric-label">Reports</div>
                        </div>
                    </div>

                    <div class="metric-card" data-metric="inactive">
                        <div class="metric-icon">
                            <i class="fas fa-user-slash"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value" id="inactive-accounts">-</div>
                            <div class="metric-label">Contas Inativadas</div>
                        </div>
                    </div>

                    <div class="metric-card" data-metric="llms">
                        <div class="metric-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value" id="llm-status">-</div>
                            <div class="metric-label">LLMs no Sistema</div>
                            <div class="metric-detail" id="llm-detail">-</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions-section">
                <div class="section-header">
                    <h2>Ações Rápidas</h2>
                    <p>Acesso direto às funcionalidades mais utilizadas</p>
                </div>
                
                <div class="actions-grid">
                    <a href="/admin/users" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="action-content">
                            <h3>Gerir Utilizadores</h3>
                            <p>Adicionar, editar ou remover utilizadores</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>

                    <a href="/admin/reports" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div class="action-content">
                            <h3>Verificar Reports</h3>
                            <p>Analisar solicitações de reativação</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>

                    <a href="/admin/system-preferences" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="action-content">
                            <h3>Configurações</h3>
                            <p>Alterar preferências do sistema</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>

                    <a href="/admin/config-history" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="action-content">
                            <h3>Histórico</h3>
                            <p>Visualizar alterações recentes</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="activity-section">
                <div class="activity-panel">
                    <div class="panel-header">
                        <h3>Atividade Recente</h3>
                        <button class="refresh-btn" id="refresh-activity">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div class="activity-list" id="activity-list">
                        <!-- Atividade será carregada dinamicamente -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Load statistics (real data only, no random updates)
        function carregarEstatisticas() {

            // Load pending reports
            fetch('/admin/api/reports')
                .then(response => response.json())
                .then(reports => {
                    const pendentes = reports.filter(r => r.status === 'PENDING').length;
                    document.getElementById('pending-reports').textContent = pendentes;
                })
                .catch(error => {
                    document.getElementById('pending-reports').textContent = '0';
                });

            // Load inactive accounts
            fetch('/admin/api/inactive-accounts')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('inactive-accounts').textContent = data.inactiveCount || '0';
                })
                .catch(error => {
                    document.getElementById('inactive-accounts').textContent = '0';
                });

            // Load LLM status
            fetch('/admin/api/llms')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('llm-status').textContent = data.format || '0 / 2 Total';
                    document.getElementById('llm-detail').textContent = data.activeLLMs + ' ativas';
                })
                .catch(error => {
                    document.getElementById('llm-status').textContent = '0 / 2 Total';
                    document.getElementById('llm-detail').textContent = '0 ativas';
                });
            
            // Load notifications
            loadNotifications();
            
            // Load recent activity
            loadRecentActivity();
        }
        
        // Load recent activity
        function loadRecentActivity() {
            fetch('/admin/api/activity')
                .then(response => response.json())
                .then(activities => {
                    const activityList = document.getElementById('activity-list');
                    
                    if (activities.length === 0) {
                        activityList.innerHTML = `
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Nenhuma atividade recente</div>
                                    <div class="activity-detail">Não há atividades para mostrar</div>
                                    <div class="activity-time">Agora</div>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    activityList.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="${getActivityIcon(activity.type)}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.title}</div>
                                <div class="activity-detail">${activity.description}</div>
                                <div class="activity-time">${formatTime(activity.timestamp)}</div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Erro ao carregar atividade:', error);
                    const activityList = document.getElementById('activity-list');
                    activityList.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">Erro ao carregar atividade</div>
                                <div class="activity-detail">Não foi possível carregar as atividades recentes</div>
                                <div class="activity-time">Agora</div>
                            </div>
                        </div>
                    `;
                });
        }
        
        // Get activity icon based on type
        function getActivityIcon(type) {
            const icons = {
                'USER_REGISTER': 'fas fa-user-plus',
                'USER_LOGIN': 'fas fa-sign-in-alt',
                'USER_ACTIVATED': 'fas fa-user-check',
                'USER_DEACTIVATED': 'fas fa-user-slash',
                'USER_DELETED': 'fas fa-user-times',
                'USER_MADE_ADMIN': 'fas fa-user-shield',
                'ADMIN_REMOVED': 'fas fa-user-minus',
                'REPORT_CREATED': 'fas fa-flag',
                'REPORT_APPROVED': 'fas fa-check-circle',
                'REPORT_REJECTED': 'fas fa-times-circle',
                'SYSTEM_CONFIG_CHANGED': 'fas fa-cog',
                'LLM_TEMPORARILY_DISABLED': 'fas fa-pause-circle',
                'LLM_TEMPORARY_DISABLE_REMOVED': 'fas fa-play-circle',
                'LLM_AUTO_REACTIVATED': 'fas fa-sync-alt',
                'CONFIG_CHANGE': 'fas fa-cog',
                'REPORT_RESOLVED': 'fas fa-check-circle',
                'SYSTEM_UPDATE': 'fas fa-sync-alt',
                'ERROR': 'fas fa-exclamation-triangle',
                'INFO': 'fas fa-info-circle'
            };
            return icons[type] || icons['INFO'];
        }
        


        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            carregarEstatisticas();
            
            // Notification bell
            const notificationBell = document.getElementById('notification-bell');
            if (notificationBell) {
                notificationBell.addEventListener('click', function() {
                    const dropdown = document.getElementById('notification-dropdown');
                    dropdown.classList.toggle('active');
                });
            }
            
            // Mark all as read
            const markAllReadBtn = document.getElementById('mark-all-read');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', function() {
                    markAllNotificationsAsRead();
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const bell = document.getElementById('notification-bell');
                const dropdown = document.getElementById('notification-dropdown');
                if (bell && dropdown && !bell.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.remove('active');
                }
            });
            
            // Refresh activity
            const refreshBtn = document.getElementById('refresh-activity');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    this.classList.add('rotating');
                    setTimeout(() => {
                        this.classList.remove('rotating');
                    }, 1000);
                    // Reload activity data
                    loadRecentActivity();
                });
            }
            
            // Refresh data every 5 minutes (not random updates)
            setInterval(carregarEstatisticas, 300000);
            

        });
        
        // Notification functions
        function loadNotifications() {
            fetch('/admin/api/notifications/count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('notification-count').textContent = data.unreadCount;
                })
                .catch(error => {
                    document.getElementById('notification-count').textContent = '0';
                });
            
            fetch('/admin/api/notifications')
                .then(response => response.json())
                .then(notifications => {
                    const list = document.getElementById('notification-list');
                    const empty = document.getElementById('notification-empty');
                    
                    if (notifications.length === 0) {
                        list.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    list.style.display = 'block';
                    empty.style.display = 'none';
                    
                    list.innerHTML = notifications.map(notification => `
                        <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                            <div class="notification-icon">
                                <i class="${getNotificationIcon(notification.type)}"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${formatTime(notification.createdAt)}</div>
                            </div>
                            ${!notification.read ? '<div class="notification-dot"></div>' : ''}
                        </div>
                    `).join('');
                    
                    document.querySelectorAll('.notification-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const notificationId = this.dataset.id;
                            markNotificationAsRead(notificationId);
                            this.classList.remove('unread');
                            this.classList.add('read');
                            this.querySelector('.notification-dot')?.remove();
                        });
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar notificações:', error);
                });
        }
        
        function markNotificationAsRead(notificationId) {
            fetch(`/admin/api/notifications/${notificationId}/read`, {
                method: 'POST'
            }).then(() => {
                loadNotifications();
            }).catch(error => {
                console.error('Erro ao marcar notificação como lida:', error);
            });
        }
        
        function markAllNotificationsAsRead() {
            fetch('/admin/api/notifications/read-all', {
                method: 'POST'
            }).then(() => {
                loadNotifications();
            }).catch(error => {
                console.error('Erro ao marcar todas como lidas:', error);
            });
        }
        
        function getNotificationIcon(type) {
            const icons = {
                'REPORT': 'fas fa-flag',
                'SYSTEM': 'fas fa-cog',
                'USER': 'fas fa-user',
                'ALERT': 'fas fa-exclamation-triangle',
                'STATS': 'fas fa-chart-bar'
            };
            return icons[type] || icons['SYSTEM'];
        }
        
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Agora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m atrás`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h atrás`;
            return date.toLocaleDateString('pt-PT');
        }
    </script>
</body>
</html> 