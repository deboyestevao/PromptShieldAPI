<!doctype html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/adminDashboard.css" rel="stylesheet" type="text/css">
    <link href="/css/adminUsers.css" rel="stylesheet" type="text/css">
    <link href="/css/adminUsersTrash.css" rel="stylesheet" type="text/css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <title>Lixeira de Utilizadores - PromptShield</title>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <span class="logo-text">PromptShield</span>
                <span class="admin-badge">Admin</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-title">Dashboard</h3>
                <a href="/admin/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Visão Geral</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Gestão</h3>
                <a href="/admin/users" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Utilizadores</span>
                </a>
                <a href="/admin/reports" class="nav-item">
                    <i class="fas fa-flag"></i>
                    <span>Reports</span>
                </a>
                <a href="/admin/system-preferences" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
                <a href="/admin/config-history" class="nav-item">
                    <i class="fas fa-history"></i>
                    <span>Histórico</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Sistema</h3>
                <a href="/chat" class="nav-item">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <div class="breadcrumb">
                    <span>Dashboard</span>
                    <i class="fas fa-chevron-right"></i>
                    <span>Utilizadores</span>
                    <i class="fas fa-chevron-right"></i>
                    <span>Lixeira</span>
                </div>
            </div>

            <div class="header-right">
                <div class="notification-container">
                    <div class="notification-bell" id="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notification-count">0</span>
                    </div>
                </div>
                
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <span class="user-name">Administrador</span>
                        <span class="user-role">Admin</span>
                    </div>
                    <a href="/auth/logout" class="logout-link" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- Lixeira Content -->
        <div class="dashboard-container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div class="welcome-content">
                    <h1>Lixeira de Utilizadores</h1>
                    <p>Utilizadores movidos para a Lixeira</p>
                </div>
            </section>

            <!-- Quick Actions Section -->
            <section class="quick-actions-section">
                <div class="section-header">
                    <h2>Ações Rápidas</h2>
                    <p>Gerencie os utilizadores na lixeira</p>
                </div>
                
                <div class="actions-grid">
                    <a href="/admin/users" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <div class="action-content">
                            <h3>Voltar aos Utilizadores</h3>
                            <p>Regressar à lista principal de utilizadores</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </div>
            </section>

            <!-- Statistics Section -->
            <section class="metrics-section">
                <div class="metrics-grid">
                    <div class="metric-card" data-metric="deleted">
                        <div class="metric-icon">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value" id="total-deleted">0</div>
                            <div class="metric-label">Utilizadores na Lixeira</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Filters Section -->
            <section class="quick-actions-section">
                <div class="section-header">
                    <h2>Filtros e Controles</h2>
                    <p>Filtre e organize os utilizadores na lixeira</p>
                </div>
                
                <div class="users-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="Pesquisar por nome, email ou username...">
                    </div>
                    
                    <div class="filter-controls">
                        <select id="role-filter">
                            <option value="">Todos os roles</option>
                            <option value="ADMIN">Administradores</option>
                            <option value="USER">Utilizadores</option>
                        </select>
                        
                        <select id="date-filter">
                            <option value="">Todas as datas</option>
                            <option value="today">Hoje</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mês</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Users List Section -->
            <section class="activity-section">
                <div class="activity-panel">
                    <div class="panel-header">
                        <h3>Lista de Utilizadores na Lixeira</h3>
                        <button class="refresh-btn" id="refresh-users">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div class="users-table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>Utilizador</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Chats</th>
                                    <th>Deletado em</th>
                                    <th>Deletado por</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Utilizadores serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Estados -->
            <div id="users-loading" class="users-loading" style="display:none;">
                <div class="loading-spinner"></div>
                <span>A carregar utilizadores...</span>
            </div>

            <div id="users-empty" class="users-empty" style="display:none;">
                <div class="empty-icon">
                    <i class="fas fa-trash"></i>
                </div>
                <h3>Lixeira vazia</h3>
                <p>Não há utilizadores na lixeira.</p>
            </div>

            <div id="users-error" class="users-error" style="display:none;">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Erro ao carregar utilizadores</h3>
                <p>Ocorreu um erro ao carregar os utilizadores da lixeira.</p>
                <button onclick="loadUsers()" class="retry-btn">
                    <i class="fas fa-sync-alt"></i>
                    Tentar Novamente
                </button>
            </div>
        </div>
    </main>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Ação</h3>
                <button class="modal-close" onclick="closeConfirmModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirm-action-btn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Utilizador -->
    <div id="user-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalhes do Utilizador</h3>
                <button class="modal-close" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="user-modal-body">
                <!-- Detalhes do utilizador serão carregados aqui -->
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];
        let filteredUsers = [];

        // Carrega utilizadores da lixeira
        async function loadUsers() {
            const loadingDiv = document.getElementById('users-loading');
            const tableContainer = document.querySelector('.users-table-container');
            const emptyDiv = document.getElementById('users-empty');
            const errorDiv = document.getElementById('users-error');
            
            loadingDiv.style.display = 'flex';
            tableContainer.style.display = 'none';
            emptyDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/admin/api/users/deleted');
                if (response.ok) {
                    const data = await response.json();
                    allUsers = data.users || [];
                    filteredUsers = [...allUsers];
                    
                    updateStats();
                    applyFilters();
                    
                    loadingDiv.style.display = 'none';
                } else {
                    throw new Error('Erro ao carregar utilizadores');
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
            }
        }

        // Atualiza estatísticas
        function updateStats() {
            document.getElementById('total-deleted').textContent = allUsers.length;
        }

        // Aplica filtros
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            filteredUsers = allUsers.filter(user => {
                // Filtro de pesquisa
                if (searchTerm) {
                    const searchText = `${user.firstName} ${user.lastName} ${user.email} ${user.username}`.toLowerCase();
                    if (!searchText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Filtro de role
                if (roleFilter && user.role !== roleFilter) {
                    return false;
                }
                
                // Filtro de data
                if (dateFilter) {
                    const deletedDate = new Date(user.deletedAt);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            if (deletedDate.toDateString() !== now.toDateString()) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (deletedDate < weekAgo) return false;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            if (deletedDate < monthAgo) return false;
                            break;
                    }
                }
                
                return true;
            });
            
            displayUsers();
        }

        // Exibe utilizadores filtrados
        function displayUsers() {
            const tableContainer = document.querySelector('.users-table-container');
            const emptyDiv = document.getElementById('users-empty');
            const tbody = document.getElementById('users-table-body');
            
            if (filteredUsers.length === 0) {
                tableContainer.style.display = 'none';
                emptyDiv.style.display = 'block';
                return;
            }
            
            tbody.innerHTML = filteredUsers.map(user => `
                <tr>
                    <td>
                        <div class="user-info-cell">
                            <div class="user-avatar-small">
                                ${user.firstName.charAt(0)}${user.lastName.charAt(0)}
                            </div>
                            <div class="user-details">
                                <div class="user-name">${user.firstName} ${user.lastName}</div>
                                <div class="user-username">@${user.username}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="role-badge ${user.role === 'ADMIN' ? 'admin' : 'user'}">
                            ${user.role === 'ADMIN' ? 'Administrador' : 'Utilizador'}
                        </span>
                    </td>
                    <td>${user.chatCount}</td>
                    <td>${formatDateTime(user.deletedAt)}</td>
                    <td>${user.deletedBy}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" onclick="viewUser(${user.id})" title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn restore-btn" onclick="restoreUser(${user.id})" title="Restaurar">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            tableContainer.style.display = 'block';
            emptyDiv.style.display = 'none';
        }

        // Restaurar utilizador
        async function restoreUser(userId) {
            showConfirmModal(
                'Tem a certeza que deseja restaurar este utilizador? O utilizador voltará a estar ativo.',
                async () => {
                    try {
                        const response = await fetch(`/admin/api/users/${userId}/restore`, { method: 'POST' });
                        if (response.ok) {
                            showNotification('Utilizador restaurado com sucesso', 'success');
                            loadUsers();
                        } else {
                            const errorData = await response.json();
                            showNotification(errorData.error || 'Erro ao restaurar utilizador', 'error');
                        }
                    } catch (error) {
                        showNotification('Erro de conexão', 'error');
                    }
                }
            );
        }

        // Ver detalhes do utilizador
        async function viewUser(userId) {
            try {
                const response = await fetch(`/admin/api/users/${userId}`);
                if (response.ok) {
                    const user = await response.json();
                    showUserModal(user);
                } else {
                    showNotification('Erro ao carregar detalhes do utilizador', 'error');
                }
            } catch (error) {
                showNotification('Erro de conexão', 'error');
            }
        }

        // Mostrar modal de confirmação
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-action-btn').onclick = () => {
                closeConfirmModal();
                onConfirm();
            };
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        // Fechar modal de confirmação
        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
        }

        // Mostrar modal de utilizador
        function showUserModal(user) {
            const modal = document.getElementById('user-modal');
            const modalBody = document.getElementById('user-modal-body');
            
            modalBody.innerHTML = `
                <div class="user-modal-content">
                    <div class="user-modal-avatar">${user.firstName.charAt(0)}${user.lastName.charAt(0)}</div>
                    <h3>${user.firstName} ${user.lastName}</h3>
                    <p class="user-modal-email">${user.email}</p>
                    <p class="user-modal-username">@${user.username}</p>
                    
                    <div class="user-modal-stats">
                        <div class="user-stat">
                            <span class="stat-label">Data de Registo</span>
                            <span class="stat-value">${formatDateTime(user.createdAt)}</span>
                        </div>
                        <div class="user-stat">
                            <span class="stat-label">Deletado em</span>
                            <span class="stat-value">${formatDateTime(user.deletedAt)}</span>
                        </div>
                        <div class="user-stat">
                            <span class="stat-label">Role</span>
                            <span class="stat-value">
                                <span class="role-badge ${user.role === 'ADMIN' ? 'admin' : 'user'}">
                                    ${user.role === 'ADMIN' ? 'Administrador' : 'Utilizador'}
                                </span>
                            </span>
                        </div>
                        <div class="user-stat">
                            <span class="stat-label">Deletado por</span>
                            <span class="stat-value">${user.deletedBy || 'N/A'}</span>
                        </div>
                        <div class="user-stat">
                            <span class="stat-label">Chats</span>
                            <span class="stat-value">${user.chatCount}</span>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Fechar modal de utilizador
        function closeUserModal() {
            document.getElementById('user-modal').style.display = 'none';
        }

        // Formatar data e hora
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleString('pt-PT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Mostrar notificação
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            
            // Pesquisa
            document.getElementById('search-input').addEventListener('input', applyFilters);
            
            // Filtros
            document.getElementById('role-filter').addEventListener('change', applyFilters);
            document.getElementById('date-filter').addEventListener('change', applyFilters);
            
            // Atualizar
            document.getElementById('refresh-users').addEventListener('click', loadUsers);
            
            // Fechar modais ao clicar fora
            window.addEventListener('click', function(event) {
                const confirmModal = document.getElementById('confirm-modal');
                const userModal = document.getElementById('user-modal');
                
                if (event.target === confirmModal) {
                    closeConfirmModal();
                }
                if (event.target === userModal) {
                    closeUserModal();
                }
            });
        });
    </script>
</body>
</html> 