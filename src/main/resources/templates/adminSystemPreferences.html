<!doctype html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/adminDashboard.css" rel="stylesheet" type="text/css">
    <link href="/css/adminSystemPreferences.css" rel="stylesheet" type="text/css">
    <title>Configurações do Sistema - PromptShield</title>
</head>
<body>
<header class="admin-header">
    <div class="admin-logo">
        <a href="/chat">PromptShield</a>
        <span class="admin-badge">Admin</span>
    </div>
    <div class="admin-user-info">
        <span class="admin-avatar">A</span>
    </div>
</header>
<main class="admin-main">
    <a href="/admin/dashboard" class="admin-back">← Voltar ao Dashboard</a>
    <h1>Configurações do Sistema</h1>
    <section id="llm-status-panel" style="margin-bottom:32px;">
        <h2 style="color:#183c7c; font-size:1.08em; font-weight:700; margin-bottom:10px;">Estado dos Modelos LLM</h2>
        <div style="display:flex; gap:32px;">
            <div id="status-openai" style="display:flex; align-items:center; gap:10px;">
                <span style="font-weight:600;">OpenAI:</span>
                <span id="status-openai-indicator" style="width:14px; height:14px; border-radius:50%; display:inline-block; background:#ccc;"></span>
                <span id="status-openai-text" style="font-size:0.98em; color:#555;">...</span>
            </div>
            <div id="status-ollama" style="display:flex; align-items:center; gap:10px;">
                <span style="font-weight:600;">Ollama:</span>
                <span id="status-ollama-indicator" style="width:14px; height:14px; border-radius:50%; display:inline-block; background:#ccc;"></span>
                <span id="status-ollama-text" style="font-size:0.98em; color:#555;">...</span>
            </div>
        </div>
    </section>
    <form id="system-prefs-form" class="admin-system-prefs-form">
        <h2 style="color:#183c7c; font-size:1.15em; font-weight:800; margin-bottom:18px;">Modelos LLM disponíveis</h2>
        <div class="admin-system-switch-group">
            <label class="admin-system-switch-label">
                <input type="checkbox" id="openai-enabled" name="openai" class="admin-system-switch"> Ativar OpenAI
            </label>
            <div style="font-size:0.98em; color:#555; margin-left:38px; margin-bottom:10px;">Permite que todos os utilizadores usem o modelo OpenAI no chat.</div>
            <label class="admin-system-switch-label">
                <input type="checkbox" id="ollama-enabled" name="ollama" class="admin-system-switch"> Ativar Ollama
            </label>
            <div style="font-size:0.98em; color:#555; margin-left:38px;">Permite que todos os utilizadores usem o modelo Ollama no chat.</div>
        </div>
        <button type="submit" class="admin-system-save-btn"><span id="save-btn-icon" style="margin-right:6px;"></span>Guardar Alterações</button>
        <div id="system-prefs-feedback" class="admin-system-feedback"></div>
    </form>

        <!-- Seção de Histórico de Configurações -->
    <section id="config-history-section" class="admin-config-history-section">
        <div class="config-history-header">
            <h2 style="color:#183c7c; font-size:1.15em; font-weight:800; margin-bottom:0;">Histórico de Alterações</h2>
            <a href="/admin/config-history" class="config-history-link">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M9 18l6-6-6-6" stroke-width="2"/>
                </svg>
                Ver Histórico Completo
            </a>
        </div>
        <div class="config-history-preview">
            <div id="config-history-loading" class="config-history-loading">
                <div class="loading-spinner"></div>
                <span>A carregar histórico...</span>
            </div>
            <div id="config-history-content" class="config-history-content" style="display:none;">
                <div id="config-history-list" class="config-history-list"></div>
            </div>
            <div id="config-history-empty" class="config-history-empty" style="display:none;">
                <p>Nenhuma alteração registada ainda.</p>
            </div>
        </div>
    </section>
</main>
</main>
<script>
// Carrega status atual dos modelos
async function loadSystemPrefs() {
    const resp = await fetch('/admin/llm-status');
    if (resp.ok) {
        const data = await resp.json();
        document.getElementById('openai-enabled').checked = !!data.openai;
        document.getElementById('ollama-enabled').checked = !!data.ollama;
        // Atualiza painel de estado
        updateLlmStatusPanel(data);
    }
}
function updateLlmStatusPanel(data) {
    const openai = !!data.openai;
    const ollama = !!data.ollama;
    const openaiIndicator = document.getElementById('status-openai-indicator');
    const openaiText = document.getElementById('status-openai-text');
    const ollamaIndicator = document.getElementById('status-ollama-indicator');
    const ollamaText = document.getElementById('status-ollama-text');
    if (openai) {
        openaiIndicator.style.background = '#2ecc40';
        openaiText.textContent = 'Online';
        openaiText.style.color = '#2ecc40';
    } else {
        openaiIndicator.style.background = '#e74c3c';
        openaiText.textContent = 'Offline';
        openaiText.style.color = '#e74c3c';
    }
    if (ollama) {
        ollamaIndicator.style.background = '#2ecc40';
        ollamaText.textContent = 'Online';
        ollamaText.style.color = '#2ecc40';
    } else {
        ollamaIndicator.style.background = '#e74c3c';
        ollamaText.textContent = 'Offline';
        ollamaText.style.color = '#e74c3c';
    }
}
loadSystemPrefs();

// Submete alterações
const form = document.getElementById('system-prefs-form');
const saveBtnIcon = document.getElementById('save-btn-icon');
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const openai = document.getElementById('openai-enabled').checked;
    const ollama = document.getElementById('ollama-enabled').checked;
    const feedback = document.getElementById('system-prefs-feedback');
    saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="#183c7c" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#183c7c" stroke-width="2" fill="none"/><path d="M12 6v6l4 2" stroke="#183c7c" stroke-width="2" fill="none"/></svg>';
    feedback.textContent = 'A guardar...';
    try {
        const resp = await fetch('/admin/system-preferences', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ openai, ollama })
        });
        if (resp.ok) {
            saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="#2ecc40" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#2ecc40" stroke-width="2" fill="none"/><path d="M7 13l3 3 7-7" stroke="#2ecc40" stroke-width="2" fill="none"/></svg>';
            feedback.textContent = 'Preferências guardadas com sucesso!';
            feedback.style.color = '#183c7c';
        } else if (resp.status === 409) {
            saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="orange" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="orange" stroke-width="2" fill="none"/><path d="M12 8v4" stroke="orange" stroke-width="2"/><circle cx="12" cy="16" r="1" fill="orange"/></svg>';
            feedback.textContent = 'As preferências foram alteradas por outro utilizador. Tente novamente.';
            feedback.style.color = 'orange';
        } else {
            saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="red" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="red" stroke-width="2" fill="none"/><path d="M8 8l8 8M16 8l-8 8" stroke="red" stroke-width="2"/></svg>';
            feedback.textContent = 'Erro ao guardar preferências.';
            feedback.style.color = 'red';
        }
    } catch {
        saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="red" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="red" stroke-width="2" fill="none"/><path d="M8 8l8 8M16 8l-8 8" stroke="red" stroke-width="2"/></svg>';
        feedback.textContent = 'Erro ao guardar preferências.';
        feedback.style.color = 'red';
    }
    setTimeout(() => { feedback.textContent = ''; saveBtnIcon.innerHTML = ''; }, 2500);
    // Atualiza painel de estado após guardar
    loadSystemPrefs();
    // Recarrega o histórico após alterações
    loadConfigHistory();
});

// Carrega histórico de configurações
async function loadConfigHistory() {
    const loadingDiv = document.getElementById('config-history-loading');
    const contentDiv = document.getElementById('config-history-content');
    const emptyDiv = document.getElementById('config-history-empty');
    const listDiv = document.getElementById('config-history-list');
    
    loadingDiv.style.display = 'flex';
    contentDiv.style.display = 'none';
    emptyDiv.style.display = 'none';
    
    try {
        const resp = await fetch('/admin/api/config-history');
        if (resp.ok) {
            const history = await resp.json();
            
            if (history.length === 0) {
                loadingDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                return;
            }
            
            // Mostrar apenas os últimos 5 registos na preview
            const recentHistory = history.slice(0, 5);
            listDiv.innerHTML = recentHistory.map(entry => `
                <div class="config-history-item">
                    <div class="config-history-header">
                        <span class="config-history-model">${entry.modelDisplay}</span>
                        <span class="config-history-action ${entry.enabled ? 'action-enabled' : 'action-disabled'}">
                            ${entry.action}
                        </span>
                    </div>
                    <div class="config-history-details">
                        <span class="config-history-user">Por: ${entry.changedBy}</span>
                        <span class="config-history-date">${formatDateTime(entry.changedAt)}</span>
                    </div>
                </div>
            `).join('');
            
            // Adicionar indicador se há mais registos
            if (history.length > 5) {
                listDiv.innerHTML += `
                    <div class="config-history-more">
                        <span>+${history.length - 5} mais registos</span>
                    </div>
                `;
            }
            
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';
        } else {
            throw new Error('Erro ao carregar histórico');
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        emptyDiv.innerHTML = '<p>Erro ao carregar histórico de configurações.</p>';
        emptyDiv.style.display = 'block';
    }
}

// Formata data e hora para exibição
function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toLocaleString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Carrega o histórico quando a página carrega
loadConfigHistory();
</script>
</body>
</html> 