<!doctype html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/adminDashboard.css" rel="stylesheet" type="text/css">
    <link href="/css/adminSystemPreferences.css" rel="stylesheet" type="text/css">
    <title>Configurações do Sistema - PromptShield</title>
</head>
<body>
<header class="admin-header">
    <div class="admin-logo">
        <a href="/chat">PromptShield</a>
        <span class="admin-badge">Admin</span>
    </div>
    <div class="admin-user-info">
        <span class="admin-avatar">A</span>
    </div>
</header>
<main class="admin-main">
    <a href="/admin/dashboard" class="admin-back">← Voltar ao Dashboard</a>
    <h1>Configurações do Sistema</h1>
    <section id="llm-status-panel" style="margin-bottom:32px;">
        <h2 style="color:#183c7c; font-size:1.08em; font-weight:700; margin-bottom:10px;">Estado dos Modelos LLM</h2>
        <div style="display:flex; gap:32px;">
            <div id="status-openai" style="display:flex; align-items:center; gap:10px;">
                <span style="font-weight:600;">OpenAI:</span>
                <span id="status-openai-indicator" style="width:14px; height:14px; border-radius:50%; display:inline-block; background:#ccc;"></span>
                <span id="status-openai-text" style="font-size:0.98em; color:#555;">...</span>
            </div>
            <div id="status-ollama" style="display:flex; align-items:center; gap:10px;">
                <span style="font-weight:600;">Ollama:</span>
                <span id="status-ollama-indicator" style="width:14px; height:14px; border-radius:50%; display:inline-block; background:#ccc;"></span>
                <span id="status-ollama-text" style="font-size:0.98em; color:#555;">...</span>
            </div>
        </div>
    </section>
    <form id="system-prefs-form" class="admin-system-prefs-form">
        <h2 style="color:#183c7c; font-size:1.15em; font-weight:800; margin-bottom:18px;">Modelos LLM disponíveis</h2>
        <div class="admin-system-switch-group">
            <label class="admin-system-switch-label">
                <input type="checkbox" id="openai-enabled" name="openai" class="admin-system-switch"> Ativar OpenAI
            </label>
            <div style="font-size:0.98em; color:#555; margin-left:38px; margin-bottom:10px;">Permite que todos os utilizadores usem o modelo OpenAI no chat.</div>
            <label class="admin-system-switch-label">
                <input type="checkbox" id="ollama-enabled" name="ollama" class="admin-system-switch"> Ativar Ollama
            </label>
            <div style="font-size:0.98em; color:#555; margin-left:38px;">Permite que todos os utilizadores usem o modelo Ollama no chat.</div>
        </div>
        <button type="submit" class="admin-system-save-btn"><span id="save-btn-icon" style="margin-right:6px;"></span>Guardar Alterações</button>
        <div id="system-prefs-feedback" class="admin-system-feedback"></div>
        <hr style="margin:32px 0 18px 0; border:none; border-top:1px solid #eee;">
        <div style="opacity:0.5; pointer-events:none;">
            <h2 style="color:#183c7c; font-size:1.08em; font-weight:700; margin-bottom:10px;">Mais opções em breve</h2>
            <ul style="margin:0 0 0 18px; padding:0; color:#888; font-size:0.98em;">
                <li>Limites de uploads e tokens</li>
                <li>Configurações de email</li>
                <li>Políticas de segurança</li>
                <li>Logs e auditoria</li>
            </ul>
        </div>
        <!-- Futuras secções podem ser adicionadas aqui -->
    </form>
</main>
<script>
// Carrega status atual dos modelos
async function loadSystemPrefs() {
    const resp = await fetch('/admin/llm-status');
    if (resp.ok) {
        const data = await resp.json();
        document.getElementById('openai-enabled').checked = !!data.openai;
        document.getElementById('ollama-enabled').checked = !!data.ollama;
        // Atualiza painel de estado
        updateLlmStatusPanel(data);
    }
}
function updateLlmStatusPanel(data) {
    const openai = !!data.openai;
    const ollama = !!data.ollama;
    const openaiIndicator = document.getElementById('status-openai-indicator');
    const openaiText = document.getElementById('status-openai-text');
    const ollamaIndicator = document.getElementById('status-ollama-indicator');
    const ollamaText = document.getElementById('status-ollama-text');
    if (openai) {
        openaiIndicator.style.background = '#2ecc40';
        openaiText.textContent = 'Online';
        openaiText.style.color = '#2ecc40';
    } else {
        openaiIndicator.style.background = '#e74c3c';
        openaiText.textContent = 'Offline';
        openaiText.style.color = '#e74c3c';
    }
    if (ollama) {
        ollamaIndicator.style.background = '#2ecc40';
        ollamaText.textContent = 'Online';
        ollamaText.style.color = '#2ecc40';
    } else {
        ollamaIndicator.style.background = '#e74c3c';
        ollamaText.textContent = 'Offline';
        ollamaText.style.color = '#e74c3c';
    }
}
loadSystemPrefs();

// Submete alterações
const form = document.getElementById('system-prefs-form');
const saveBtnIcon = document.getElementById('save-btn-icon');
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const openai = document.getElementById('openai-enabled').checked;
    const ollama = document.getElementById('ollama-enabled').checked;
    const feedback = document.getElementById('system-prefs-feedback');
    saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="#183c7c" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#183c7c" stroke-width="2" fill="none"/><path d="M12 6v6l4 2" stroke="#183c7c" stroke-width="2" fill="none"/></svg>';
    feedback.textContent = 'A guardar...';
    try {
        const resp = await fetch('/admin/system-preferences', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ openai, ollama })
        });
        if (resp.ok) {
            saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="#2ecc40" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#2ecc40" stroke-width="2" fill="none"/><path d="M7 13l3 3 7-7" stroke="#2ecc40" stroke-width="2" fill="none"/></svg>';
            feedback.textContent = 'Preferências guardadas com sucesso!';
            feedback.style.color = '#183c7c';
        } else if (resp.status === 409) {
            saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="orange" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="orange" stroke-width="2" fill="none"/><path d="M12 8v4" stroke="orange" stroke-width="2"/><circle cx="12" cy="16" r="1" fill="orange"/></svg>';
            feedback.textContent = 'As preferências foram alteradas por outro utilizador. Tente novamente.';
            feedback.style.color = 'orange';
        } else {
            saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="red" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="red" stroke-width="2" fill="none"/><path d="M8 8l8 8M16 8l-8 8" stroke="red" stroke-width="2"/></svg>';
            feedback.textContent = 'Erro ao guardar preferências.';
            feedback.style.color = 'red';
        }
    } catch {
        saveBtnIcon.innerHTML = '<svg width="18" height="18" fill="none" stroke="red" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="red" stroke-width="2" fill="none"/><path d="M8 8l8 8M16 8l-8 8" stroke="red" stroke-width="2"/></svg>';
        feedback.textContent = 'Erro ao guardar preferências.';
        feedback.style.color = 'red';
    }
    setTimeout(() => { feedback.textContent = ''; saveBtnIcon.innerHTML = ''; }, 2500);
    // Atualiza painel de estado após guardar
    loadSystemPrefs();
});
</script>
</body>
</html> 